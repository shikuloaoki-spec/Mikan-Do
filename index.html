<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="ã¿ã‹ã‚“å ‚ â€” æ²¡ã«ãªã£ãŸã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¨­å®šãƒ»è¡£è£…æ¡ˆãƒ»æ´»å‹•åã‚’ä¾›é¤Šã—ã€ãƒ•ã‚¡ãƒ³ã®æŠ•ç¥¨ã§å¾©æ´»ã‚’ç›®æŒ‡ã™ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–">
<meta property="og:title" content="ã¿ã‹ã‚“å ‚ / Mikan Do">
<meta property="og:description" content="æ²¡ã«ãªã£ãŸã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¨­å®šãŸã¡ã®ã€å®‰ã‚‰ã‹ãªçœ ã‚Šã‚’ã€‚ãƒ•ã‚¡ãƒ³ã®å£°ãŒã‚ã‚Œã°ã€ã„ã¤ã‹ã¾ãŸç›®è¦šã‚ã‚‹ã‹ã‚‚ã—ã‚Œãªã„ã€‚">
<title>ã¿ã‹ã‚“å ‚ / Mikan Do</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@300;400;600&family=Shippori+Mincho:wght@400;500;700&family=DM+Serif+Display:ital@0;1&family=Crimson+Pro:ital,wght@0,300;0,400;1,300&display=swap" rel="stylesheet">

<!-- Supabase JS SDK v2 -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

<style>
/* â”€â”€ Variables â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
:root {
  --ink:#1a1410; --ink-light:#231a13; --paper:#f5f0e8; --smoke:#8a7d6b;
  --ash:#b5a898; --ember:#c44a2a; --gold:#c9975a; --pale-gold:#e8c88a;
  --deep:#2d1f12; --border:rgba(201,151,90,.18); --border-h:rgba(201,151,90,.45);
  --font-jp:'Shippori Mincho','Noto Serif JP',serif;
  --font-en:'DM Serif Display','Crimson Pro',serif;
  --font-body:'Noto Serif JP','Crimson Pro',serif;
  --tr:.28s cubic-bezier(.4,0,.2,1);
}

/* â”€â”€ Reset â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
html{scroll-behavior:smooth;font-size:16px}
body{background:var(--ink);color:var(--paper);font-family:var(--font-body);min-height:100vh;overflow-x:hidden;-webkit-font-smoothing:antialiased}
a{color:inherit;text-decoration:none} button{cursor:pointer} input,textarea,select{font-family:inherit} img{max-width:100%;display:block}
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-track{background:var(--ink)}
::-webkit-scrollbar-thumb{background:rgba(201,151,90,.25);border-radius:2px}
::-webkit-scrollbar-thumb:hover{background:var(--gold)}
body::before{content:'';position:fixed;inset:0;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.035'/%3E%3C/svg%3E");pointer-events:none;z-index:9998;mix-blend-mode:overlay}

/* â”€â”€ Particles â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#particles{position:fixed;inset:0;pointer-events:none;z-index:1;overflow:hidden}
.particle{position:absolute;border-radius:50%;opacity:0;animation:particle-rise linear infinite}
@keyframes particle-rise{0%{transform:translateY(100vh) translateX(0) scale(0);opacity:0}8%{opacity:.7}92%{opacity:.15}100%{transform:translateY(-40px) translateX(var(--d,0px)) scale(.2);opacity:0}}

/* â”€â”€ Auth Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#auth-bar{
  display:flex;align-items:center;justify-content:flex-end;gap:10px;
  padding:10px 20px;background:rgba(255,255,255,.015);
  border-bottom:1px solid rgba(201,151,90,.1);
  position:relative;z-index:100;
}
.auth-avatar{width:28px;height:28px;border-radius:50%;object-fit:cover;border:1px solid var(--border)}
.auth-name{font-size:12px;color:var(--ash);letter-spacing:.04em}
.auth-btn{
  background:none;border:1px solid rgba(201,151,90,.3);
  color:var(--gold);font-family:var(--font-body);
  font-size:11px;letter-spacing:.12em;padding:5px 14px;
  transition:all var(--tr);display:flex;align-items:center;gap:6px;
}
.auth-btn:hover{background:rgba(201,151,90,.08);border-color:var(--gold)}
.auth-btn.logout{color:var(--smoke);border-color:rgba(138,125,107,.25)}
.auth-btn.logout:hover{color:var(--ember);border-color:var(--ember)}
.auth-status-dot{width:6px;height:6px;border-radius:50%;background:var(--smoke)}
.auth-status-dot.online{background:#7ac49c}
.auth-skeleton{width:80px;height:22px;background:rgba(201,151,90,.08);animation:skeleton-pulse 1.5s ease-in-out infinite}
@keyframes skeleton-pulse{0%,100%{opacity:.4}50%{opacity:.9}}

/* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#site-header{position:relative;text-align:center;padding:64px 20px 52px;z-index:10}
.lang-switcher{position:absolute;top:20px;right:20px;display:flex;gap:6px;z-index:20}
.lang-btn{background:none;border:1px solid rgba(201,151,90,.25);color:var(--smoke);font-family:var(--font-en);font-size:12px;letter-spacing:.08em;padding:4px 14px;transition:var(--tr)}
.lang-btn:hover,.lang-btn.active{border-color:var(--gold);color:var(--gold)}
.header-ornament{display:flex;align-items:center;justify-content:center;gap:14px;margin-bottom:20px}
.orn-line{height:1px;width:56px}
.orn-l{background:linear-gradient(90deg,transparent,var(--gold))}
.orn-r{background:linear-gradient(90deg,var(--gold),transparent)}
.orn-dot{color:var(--gold);font-size:14px;opacity:.7}
.site-title{font-family:var(--font-jp);font-size:clamp(34px,7vw,70px);font-weight:700;letter-spacing:.28em;line-height:1;animation:title-pulse 5s ease-in-out infinite alternate}
@keyframes title-pulse{from{text-shadow:0 0 40px rgba(201,151,90,.18),0 2px 0 rgba(0,0,0,.5)}to{text-shadow:0 0 90px rgba(201,151,90,.45),0 2px 0 rgba(0,0,0,.5)}}
.site-title-en{font-family:var(--font-en);font-style:italic;font-size:clamp(13px,2.2vw,20px);color:var(--gold);letter-spacing:.18em;margin-top:10px;opacity:.82}
.site-tagline{font-family:var(--font-body);font-weight:300;font-size:clamp(10px,1.6vw,13px);color:var(--ash);letter-spacing:.28em;line-height:2.2;margin-top:18px}

/* â”€â”€ Stats â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.stats-bar{display:flex;justify-content:center;border-top:1px solid var(--border);border-bottom:1px solid var(--border);background:rgba(255,255,255,.015)}
.stat-item{flex:1;max-width:220px;text-align:center;padding:18px 12px;border-right:1px solid rgba(201,151,90,.1);transition:background var(--tr)}
.stat-item:last-child{border-right:none}
.stat-item:hover{background:rgba(201,151,90,.04)}
.stat-number{font-family:var(--font-en);font-size:26px;color:var(--gold);line-height:1}
.stat-label{font-family:var(--font-body);font-size:9px;color:var(--smoke);letter-spacing:.22em;margin-top:4px}

/* â”€â”€ Nav â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#main-nav{display:flex;justify-content:center;margin:36px auto 0;max-width:860px;border:1px solid var(--border);position:relative;z-index:10}
.nav-btn{flex:1;background:none;border:none;color:var(--ash);font-family:var(--font-body);font-size:12px;letter-spacing:.14em;padding:15px 6px;border-right:1px solid rgba(201,151,90,.1);position:relative;overflow:hidden;transition:color var(--tr),background var(--tr)}
.nav-btn:last-child{border-right:none}
.nav-btn::after{content:'';position:absolute;bottom:0;left:50%;transform:translateX(-50%);width:0;height:2px;background:var(--gold);transition:width var(--tr)}
.nav-btn:hover,.nav-btn.active{color:var(--gold);background:rgba(201,151,90,.04)}
.nav-btn:hover::after,.nav-btn.active::after{width:55%}

/* â”€â”€ Main â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#main-content{padding:52px 20px 120px;position:relative;z-index:10}

/* â”€â”€ Section header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.section-head{display:flex;align-items:baseline;gap:14px;margin-bottom:32px}
.section-head-title{font-family:var(--font-jp);font-size:18px;color:var(--paper);letter-spacing:.2em;white-space:nowrap}
.section-head-sub{font-family:var(--font-en);font-style:italic;color:var(--smoke);font-size:13px}
.section-head-line{flex:1;height:1px;background:linear-gradient(90deg,var(--border),transparent)}

/* â”€â”€ Search â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.search-wrap{position:relative;margin-bottom:20px}
.search-icon{position:absolute;left:14px;top:50%;transform:translateY(-50%);color:var(--smoke);font-size:14px;pointer-events:none}
#search-input{width:100%;background:rgba(255,255,255,.03);border:1px solid var(--border);color:var(--paper);font-family:var(--font-body);font-size:13px;letter-spacing:.05em;padding:12px 14px 12px 40px;outline:none;transition:border-color var(--tr),background var(--tr)}
#search-input::placeholder{color:var(--smoke)}
#search-input:focus{border-color:var(--gold);background:rgba(201,151,90,.04)}
.search-clear{position:absolute;right:12px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--smoke);font-size:16px;display:none;line-height:1;transition:color var(--tr)}
.search-clear:hover{color:var(--paper)}
.search-clear.visible{display:block}

/* â”€â”€ Filters â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.filter-bar{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:24px}
.filter-chip{background:none;border:1px solid rgba(201,151,90,.2);color:var(--ash);font-family:var(--font-body);font-size:11px;letter-spacing:.1em;padding:6px 15px;transition:all var(--tr)}
.filter-chip:hover,.filter-chip.active{background:rgba(201,151,90,.1);border-color:var(--gold);color:var(--pale-gold)}
.sort-bar{display:flex;align-items:center;gap:12px;margin-bottom:24px}
.sort-label{font-size:11px;color:var(--smoke);letter-spacing:.1em}
.sort-btn{background:none;border:none;color:var(--ash);font-family:var(--font-body);font-size:11px;letter-spacing:.08em;padding:4px 0;border-bottom:1px solid transparent;transition:all var(--tr)}
.sort-btn:hover,.sort-btn.active{color:var(--gold);border-bottom-color:var(--gold)}
.results-info{font-size:11px;color:var(--smoke);letter-spacing:.08em;margin-bottom:16px;height:16px}

/* â”€â”€ Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.layout-grid{display:grid;grid-template-columns:1fr 268px;gap:36px;align-items:start;max-width:1200px;margin:0 auto}
@media(max-width:900px){.layout-grid{grid-template-columns:1fr}.sidebar{display:none}}
#cards-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:1px;background:rgba(201,151,90,.08)}
@media(max-width:600px){#cards-grid{grid-template-columns:1fr}}

/* â”€â”€ Card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.botsu-card{background:var(--ink);padding:28px 24px;position:relative;transition:background var(--tr);overflow:hidden;cursor:pointer;display:flex;flex-direction:column}
.botsu-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,var(--ember),transparent);opacity:0;transition:opacity var(--tr)}
.botsu-card:hover{background:rgba(201,151,90,.035)}
.botsu-card:hover::before{opacity:1}
.card-badge{display:inline-flex;align-items:center;gap:5px;font-family:var(--font-body);font-size:10px;letter-spacing:.14em;color:var(--smoke);border:1px solid rgba(138,125,107,.28);padding:3px 10px;margin-bottom:14px;width:fit-content}
.badge-dot{width:5px;height:5px;border-radius:50%;flex-shrink:0}
.badge-dot.design{background:var(--ember)}.badge-dot.outfit{background:#7a9cc4}.badge-dot.name{background:#9c7ac4}.badge-dot.lore{background:var(--gold)}.badge-dot.bgm{background:#7ac49c}.badge-dot.other{background:var(--ash)}
.card-thumb{width:100%;aspect-ratio:16/9;position:relative;overflow:hidden;margin-bottom:18px;flex-shrink:0;background:linear-gradient(135deg,rgba(201,151,90,.05),rgba(26,20,16,.9));border:1px solid rgba(201,151,90,.08)}
.card-thumb img{width:100%;height:100%;object-fit:cover;opacity:.65;filter:sepia(15%);transition:opacity var(--tr),filter var(--tr)}
.botsu-card:hover .card-thumb img{opacity:.82;filter:sepia(4%)}
.card-thumb-kanji{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-family:var(--font-jp);font-size:72px;font-weight:700;color:rgba(201,151,90,.07);user-select:none;transition:color var(--tr)}
.botsu-card:hover .card-thumb-kanji{color:rgba(201,151,90,.11)}
.card-title{font-family:var(--font-jp);font-size:17px;font-weight:700;color:var(--paper);letter-spacing:.08em;line-height:1.45;margin-bottom:10px}
.card-creator{display:flex;align-items:center;gap:8px;margin-bottom:14px}
.avatar{border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--ink);flex-shrink:0}
.avatar-sm{width:22px;height:22px;font-size:10px}
.avatar-md{width:30px;height:30px;font-size:13px}
.creator-name{font-size:12px;color:var(--ash);letter-spacing:.04em}
.card-desc{font-size:12px;line-height:1.95;color:var(--ash);font-weight:300;margin-bottom:18px;flex:1;display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden}
.card-footer{display:flex;align-items:center;justify-content:space-between;margin-top:auto}
.vote-btn{display:flex;align-items:center;gap:6px;background:none;border:1px solid rgba(201,151,90,.22);color:var(--ash);font-family:var(--font-body);font-size:11px;letter-spacing:.09em;padding:7px 14px;transition:all var(--tr);position:relative;overflow:hidden}
.vote-btn::before{content:'';position:absolute;inset:0;background:rgba(196,74,42,.1);transform:translateX(-100%);transition:transform .35s ease}
.vote-btn:hover::before,.vote-btn.voted::before{transform:translateX(0)}
.vote-btn:hover,.vote-btn.voted{border-color:var(--ember);color:#e87a5a}
.vote-num{font-family:var(--font-en);font-size:15px;color:var(--gold);transition:color var(--tr)}
.vote-btn.voted .vote-num{color:#e87a5a}
.card-date{font-size:10px;color:var(--smoke);letter-spacing:.04em}
.card-hof{position:absolute;top:12px;right:-22px;background:var(--gold);color:var(--ink);font-family:var(--font-body);font-size:9px;font-weight:700;letter-spacing:.12em;padding:3px 28px;transform:rotate(35deg)}

/* Card loading skeleton */
.card-skeleton{background:var(--ink);padding:28px 24px}
.skel-line{background:rgba(201,151,90,.07);border-radius:2px;margin-bottom:12px;animation:skeleton-pulse 1.5s ease-in-out infinite}
.skel-thumb{width:100%;aspect-ratio:16/9;background:rgba(201,151,90,.06);margin-bottom:18px;animation:skeleton-pulse 1.5s ease-in-out infinite}

/* â”€â”€ Empty state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.empty-state{grid-column:1/-1;text-align:center;padding:80px 24px;background:var(--ink)}
.empty-kanji{font-family:var(--font-jp);font-size:72px;color:rgba(201,151,90,.08);margin-bottom:14px;line-height:1}
.empty-text{font-size:12px;color:var(--smoke);letter-spacing:.2em;line-height:2}

/* â”€â”€ Sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.sidebar{position:sticky;top:20px}
.sidebar-block{border:1px solid var(--border);padding:22px;margin-bottom:20px;background:rgba(255,255,255,.012)}
.sidebar-title{font-family:var(--font-jp);font-size:13px;color:var(--gold);letter-spacing:.2em;margin-bottom:18px;padding-bottom:11px;border-bottom:1px solid rgba(201,151,90,.13)}
.rank-item{display:flex;align-items:flex-start;gap:10px;padding:10px 0;border-bottom:1px solid rgba(201,151,90,.07);cursor:pointer;transition:opacity var(--tr)}
.rank-item:last-child{border-bottom:none;padding-bottom:0}
.rank-item:hover{opacity:.68}
.rank-num{font-family:var(--font-en);font-size:20px;color:rgba(201,151,90,.25);line-height:1;min-width:26px}
.rank-num.gold{color:var(--gold)}.rank-num.silver{color:#a8a8b0}.rank-num.bronze{color:#b08060}
.rank-info{flex:1;overflow:hidden}
.rank-title-text{font-family:var(--font-jp);font-size:12px;color:var(--paper);letter-spacing:.04em;margin-bottom:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.rank-creator-text{font-size:10px;color:var(--smoke)}
.rank-votes{font-family:var(--font-en);font-size:17px;color:var(--ember);align-self:center}
.email-row{display:flex;gap:6px;margin-top:10px}
.email-input{flex:1;background:rgba(255,255,255,.04);border:1px solid var(--border);color:var(--paper);font-size:12px;padding:8px 10px;outline:none;font-family:inherit;transition:border-color var(--tr)}
.email-input:focus{border-color:var(--gold)}
.email-btn{background:none;border:1px solid var(--border);color:var(--gold);font-family:var(--font-body);font-size:11px;letter-spacing:.1em;padding:8px 12px;transition:all var(--tr)}
.email-btn:hover{border-color:var(--gold);background:rgba(201,151,90,.08)}

/* â”€â”€ Ranking page â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.ranking-page{max-width:860px;margin:0 auto}
.ranking-hero{text-align:center;padding:32px 0 48px;border-bottom:1px solid var(--border);margin-bottom:40px}
.ranking-hero-sub{font-family:var(--font-en);font-style:italic;font-size:14px;color:var(--ash);letter-spacing:.1em;margin-top:8px}
.ranking-full-item{display:flex;gap:20px;padding:28px 12px;border-bottom:1px solid rgba(201,151,90,.08);cursor:pointer;transition:background var(--tr)}
.ranking-full-item:hover{background:rgba(201,151,90,.03)}
.ranking-full-num{font-family:var(--font-en);font-size:40px;color:rgba(201,151,90,.18);line-height:1;min-width:56px;text-align:right;align-self:center}
.ranking-full-num.gold{color:var(--gold)}.ranking-full-num.silver{color:#a8a8b0}.ranking-full-num.bronze{color:#b08060}
.ranking-full-thumb{width:90px;height:60px;flex-shrink:0;background:rgba(201,151,90,.05);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;font-family:var(--font-jp);font-size:22px;color:rgba(201,151,90,.15);overflow:hidden}
.ranking-full-thumb img{width:100%;height:100%;object-fit:cover;opacity:.7}
.ranking-full-info{flex:1}
.ranking-full-title{font-family:var(--font-jp);font-size:18px;color:var(--paper);letter-spacing:.08em;margin-bottom:6px}
.ranking-full-creator{display:flex;align-items:center;gap:8px;margin-bottom:8px}
.ranking-full-desc{font-size:12px;color:var(--ash);line-height:1.8;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.ranking-full-votes{font-family:var(--font-en);font-size:32px;color:var(--ember);align-self:center;flex-shrink:0;text-align:center;min-width:60px}
.ranking-full-votes small{display:block;font-size:10px;color:var(--smoke);font-family:var(--font-body);letter-spacing:.1em;margin-top:2px}

/* â”€â”€ Post form â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.post-page{max-width:660px;margin:0 auto}
.auth-gate{text-align:center;padding:60px 20px;border:1px solid var(--border)}
.auth-gate-icon{font-size:48px;margin-bottom:20px;opacity:.35}
.auth-gate-title{font-family:var(--font-jp);font-size:22px;color:var(--paper);letter-spacing:.2em;margin-bottom:12px}
.auth-gate-text{font-size:13px;color:var(--ash);line-height:2;margin-bottom:28px}
.twitter-login-btn{display:inline-flex;align-items:center;gap:10px;background:none;border:1px solid var(--gold);color:var(--gold);font-family:var(--font-jp);font-size:14px;letter-spacing:.18em;padding:14px 32px;transition:all var(--tr);position:relative;overflow:hidden}
.twitter-login-btn::before{content:'';position:absolute;inset:0;background:var(--gold);transform:translateX(-100%);transition:transform .38s ease;z-index:0}
.twitter-login-btn:hover::before{transform:translateX(0)}
.twitter-login-btn:hover{color:var(--ink)}
.twitter-login-btn span{position:relative;z-index:1}
.form-intro{text-align:center;margin-bottom:44px;padding-bottom:36px;border-bottom:1px solid var(--border)}
.form-intro-title{font-family:var(--font-jp);font-size:26px;color:var(--paper);letter-spacing:.22em;margin-bottom:12px}
.form-intro-text{font-size:13px;color:var(--ash);line-height:2.1;letter-spacing:.05em;font-weight:300}
.form-progress{display:flex;align-items:center;gap:0;margin-bottom:40px}
.progress-step{flex:1;text-align:center;position:relative}
.progress-step::after{content:'';position:absolute;top:14px;left:calc(50% + 16px);right:calc(-50% + 16px);height:1px;background:var(--border)}
.progress-step:last-child::after{display:none}
.progress-dot{width:28px;height:28px;border-radius:50%;border:1px solid var(--border);display:flex;align-items:center;justify-content:center;margin:0 auto 8px;font-family:var(--font-en);font-size:13px;color:var(--smoke);transition:all var(--tr);background:var(--ink);position:relative;z-index:1}
.progress-step.active .progress-dot{border-color:var(--gold);color:var(--gold)}
.progress-step.done .progress-dot{background:var(--gold);border-color:var(--gold);color:var(--ink)}
.progress-label{font-size:10px;color:var(--smoke);letter-spacing:.1em}
.progress-step.active .progress-label{color:var(--gold)}
.form-panel{display:none}
.form-panel.active{display:block;animation:panel-in .35s ease}
@keyframes panel-in{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
.form-group{margin-bottom:28px}
.form-label{display:block;font-family:var(--font-body);font-size:11px;letter-spacing:.2em;color:var(--gold);margin-bottom:9px}
.form-required{color:var(--ember);margin-left:3px}
.form-hint{font-size:11px;color:var(--smoke);margin-top:5px;letter-spacing:.04em;line-height:1.6}
.form-input,.form-textarea,.form-select{width:100%;background:rgba(255,255,255,.03);border:1px solid var(--border);color:var(--paper);font-family:var(--font-body);font-size:13px;padding:13px 15px;outline:none;appearance:none;transition:border-color var(--tr),background var(--tr)}
.form-input::placeholder,.form-textarea::placeholder{color:var(--smoke);font-weight:300}
.form-input:focus,.form-textarea:focus,.form-select:focus{border-color:var(--gold);background:rgba(201,151,90,.04)}
.form-input.error,.form-textarea.error{border-color:var(--ember)}
.form-error-msg{font-size:11px;color:var(--ember);margin-top:5px;letter-spacing:.04em;display:none}
.form-error-msg.visible{display:block}
.form-textarea{min-height:130px;resize:vertical;line-height:1.85}
.char-counter{font-size:10px;color:var(--smoke);text-align:right;margin-top:4px;letter-spacing:.04em}
.char-counter.warn{color:var(--ember)}
.form-select{background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6' viewBox='0 0 10 6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%238a7d6b'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 14px center;padding-right:36px;cursor:pointer}
.form-select option{background:var(--deep)}
.cat-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:7px}
@media(max-width:480px){.cat-grid{grid-template-columns:1fr}}
.cat-radio{display:none}
.cat-label{display:flex;align-items:center;gap:10px;border:1px solid rgba(201,151,90,.18);padding:12px 15px;cursor:pointer;font-family:var(--font-body);font-size:12px;letter-spacing:.09em;color:var(--ash);transition:all var(--tr)}
.cat-radio:checked+.cat-label{background:rgba(201,151,90,.1);border-color:var(--gold);color:var(--pale-gold)}
.cat-label:hover{border-color:var(--border-h);color:var(--paper)}
.tags-wrap{border:1px solid var(--border);padding:8px 10px;display:flex;flex-wrap:wrap;gap:6px;background:rgba(255,255,255,.03);min-height:48px;align-items:center;transition:border-color var(--tr);cursor:text}
.tags-wrap:focus-within{border-color:var(--gold);background:rgba(201,151,90,.04)}
.tag-pill{display:flex;align-items:center;gap:5px;background:rgba(201,151,90,.12);border:1px solid rgba(201,151,90,.3);font-family:var(--font-body);font-size:11px;letter-spacing:.06em;color:var(--pale-gold);padding:3px 9px}
.tag-remove{background:none;border:none;color:var(--smoke);font-size:12px;line-height:1;padding:0;transition:color var(--tr)}
.tag-remove:hover{color:var(--ember)}
.tags-input{flex:1;min-width:100px;background:none;border:none;color:var(--paper);font-family:inherit;font-size:12px;outline:none;padding:2px 4px}
.tags-input::placeholder{color:var(--smoke)}
.upload-zone{border:1px dashed rgba(201,151,90,.28);padding:36px 20px;text-align:center;cursor:pointer;transition:all var(--tr);position:relative;overflow:hidden}
.upload-zone:hover,.upload-zone.drag-over{border-color:var(--gold);background:rgba(201,151,90,.05)}
.upload-zone.has-file{border-style:solid;border-color:var(--gold)}
.upload-icon{font-size:28px;margin-bottom:10px;opacity:.45}
.upload-text{font-size:12px;color:var(--ash);letter-spacing:.09em;line-height:1.7}
.upload-preview{width:100%;max-height:200px;object-fit:contain;margin-top:12px;display:none;border:1px solid var(--border)}
.upload-preview.visible{display:block}
.upload-filename{font-size:11px;color:var(--gold);margin-top:8px;display:none}
.upload-filename.visible{display:block}
.form-nav{display:flex;gap:10px;margin-top:36px}
.btn-prev,.btn-next,.btn-submit{font-family:var(--font-jp);font-size:14px;letter-spacing:.22em;padding:16px 0;border:1px solid;transition:all var(--tr);position:relative;overflow:hidden}
.btn-prev{flex:0 0 120px;background:none;border-color:var(--border);color:var(--smoke)}
.btn-prev:hover{border-color:var(--gold);color:var(--gold)}
.btn-next,.btn-submit{flex:1}
.btn-next{background:none;border-color:var(--gold);color:var(--gold)}
.btn-submit{background:none;border-color:var(--gold);color:var(--gold)}
.btn-next::before,.btn-submit::before{content:'';position:absolute;inset:0;background:var(--gold);transform:translateX(-100%);transition:transform .38s ease;z-index:0}
.btn-next:hover::before,.btn-submit:hover::before{transform:translateX(0)}
.btn-next:hover,.btn-submit:hover{color:var(--ink)}
.btn-next span,.btn-submit span{position:relative;z-index:1}
.btn-submit.loading{pointer-events:none;opacity:.7}
.step-summary{background:rgba(201,151,90,.04);border:1px solid var(--border);padding:20px;margin-bottom:28px}
.step-summary-title{font-size:11px;color:var(--smoke);letter-spacing:.2em;margin-bottom:14px}
.summary-row{display:flex;gap:12px;margin-bottom:10px;font-size:12px}
.summary-key{color:var(--smoke);min-width:90px;letter-spacing:.06em}
.summary-val{color:var(--paper);flex:1;font-weight:300}
.submit-success{text-align:center;padding:60px 20px;display:none}
.submit-success.visible{display:block;animation:panel-in .5s ease}
.success-kanji{font-family:var(--font-jp);font-size:80px;color:rgba(201,151,90,.25);margin-bottom:24px;line-height:1;animation:candle-flicker 3s ease-in-out infinite}
@keyframes candle-flicker{0%,100%{opacity:.25;transform:scale(1)}50%{opacity:.4;transform:scale(1.03)}}
.success-title{font-family:var(--font-jp);font-size:22px;color:var(--paper);letter-spacing:.22em;margin-bottom:14px}
.success-text{font-size:13px;color:var(--ash);line-height:2;letter-spacing:.05em}
.success-btn{display:inline-block;margin-top:32px;background:none;border:1px solid var(--gold);color:var(--gold);font-family:var(--font-jp);font-size:13px;letter-spacing:.22em;padding:14px 36px;transition:all var(--tr)}
.success-btn:hover{background:var(--gold);color:var(--ink)}

/* â”€â”€ HoF â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.hof-page{max-width:900px;margin:0 auto}
.hof-hero{text-align:center;padding:40px 20px 48px;border-bottom:1px solid var(--border);margin-bottom:40px}
.hof-hero-title{font-family:var(--font-jp);font-size:clamp(28px,5vw,52px);color:var(--gold);letter-spacing:.25em;margin-bottom:12px}
.hof-hero-text{font-family:var(--font-en);font-style:italic;font-size:14px;color:var(--ash);letter-spacing:.1em}
.hof-card{border:1px solid rgba(201,151,90,.35);padding:36px;margin-bottom:28px;background:rgba(201,151,90,.02);position:relative;overflow:hidden}
.hof-card::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,rgba(201,151,90,.04),transparent 60%);pointer-events:none}
.hof-badge{display:inline-flex;align-items:center;gap:6px;background:var(--gold);color:var(--ink);font-family:var(--font-body);font-size:10px;font-weight:700;letter-spacing:.15em;padding:4px 14px;margin-bottom:18px}
.hof-title{font-family:var(--font-jp);font-size:24px;color:var(--paper);letter-spacing:.1em;margin-bottom:10px}
.hof-story{font-size:13px;color:var(--ash);line-height:2;font-weight:300;margin-top:16px}
.hof-votes{display:flex;align-items:baseline;gap:6px;margin-top:20px}
.hof-votes-num{font-family:var(--font-en);font-size:36px;color:var(--gold)}
.hof-votes-label{font-size:11px;color:var(--smoke);letter-spacing:.15em}

/* â”€â”€ Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#modal-overlay{position:fixed;inset:0;background:rgba(8,6,4,.93);z-index:2000;display:none;align-items:flex-start;justify-content:center;padding:24px 16px;overflow-y:auto;backdrop-filter:blur(5px)}
#modal-overlay.open{display:flex;animation:overlay-in .25s ease}
@keyframes overlay-in{from{opacity:0}to{opacity:1}}
.modal{background:var(--ink-light);border:1px solid rgba(201,151,90,.28);width:100%;max-width:620px;padding:44px;position:relative;animation:modal-in .3s ease;margin:auto}
@keyframes modal-in{from{transform:translateY(18px);opacity:0}to{transform:translateY(0);opacity:1}}
@media(max-width:600px){.modal{padding:28px 20px}}
.modal-close{position:absolute;top:16px;right:18px;background:none;border:none;color:var(--smoke);font-size:18px;line-height:1;transition:color var(--tr)}
.modal-close:hover{color:var(--paper)}
.modal-thumb{width:100%;aspect-ratio:16/9;background:linear-gradient(135deg,rgba(201,151,90,.06),rgba(26,20,16,.9));border:1px solid rgba(201,151,90,.1);display:flex;align-items:center;justify-content:center;font-family:var(--font-jp);font-size:80px;color:rgba(201,151,90,.08);margin-bottom:26px;overflow:hidden}
.modal-thumb img{width:100%;height:100%;object-fit:cover;opacity:.72;filter:sepia(12%)}
.modal-title{font-family:var(--font-jp);font-size:24px;color:var(--paper);letter-spacing:.1em;line-height:1.4;margin-bottom:8px}
.modal-creator-row{display:flex;align-items:center;gap:10px;margin-bottom:24px;padding-bottom:24px;border-bottom:1px solid rgba(201,151,90,.13)}
.modal-meta{font-size:10px;color:var(--smoke);margin-top:2px}
.modal-desc{font-size:13px;line-height:2.05;color:var(--ash);font-weight:300;margin-bottom:22px;white-space:pre-wrap}
.modal-tags{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:28px}
.modal-tag{font-family:var(--font-body);font-size:10px;letter-spacing:.09em;color:var(--smoke);border:1px solid rgba(138,125,107,.22);padding:3px 9px}
.modal-vote-area{display:flex;align-items:center;gap:16px;padding:20px;border:1px solid rgba(201,151,90,.13);background:rgba(255,255,255,.01);margin-bottom:28px}
@media(max-width:520px){.modal-vote-area{flex-direction:column;align-items:flex-start;gap:12px}}
.modal-vote-text{flex:1;font-size:12px;color:var(--ash);line-height:1.75;letter-spacing:.04em}
.modal-vote-btn{background:none;border:1px solid var(--ember);color:var(--ember);font-family:var(--font-body);font-size:11px;letter-spacing:.13em;padding:11px 20px;white-space:nowrap;transition:all var(--tr)}
.modal-vote-btn:hover,.modal-vote-btn.voted{background:var(--ember);color:var(--paper)}
.modal-vote-count{font-family:var(--font-en);font-size:16px}
.comments-section{border-top:1px solid rgba(201,151,90,.13);padding-top:26px}
.comments-title{font-family:var(--font-jp);font-size:13px;color:var(--gold);letter-spacing:.18em;margin-bottom:18px}
.comment-item{padding:14px 0;border-bottom:1px solid rgba(201,151,90,.07)}
.comment-item:last-of-type{border-bottom:none}
.comment-head{display:flex;align-items:center;gap:8px;margin-bottom:7px}
.comment-author-name{font-size:11px;color:var(--ash);letter-spacing:.04em}
.comment-time{font-size:10px;color:var(--smoke);margin-left:auto}
.comment-text{font-size:12px;color:var(--ash);line-height:1.85;padding-left:28px;font-weight:300}
.comment-input-wrap{display:flex;gap:7px;margin-top:16px}
.comment-input{flex:1;background:rgba(255,255,255,.03);border:1px solid var(--border);color:var(--paper);font-family:inherit;font-size:12px;padding:9px 12px;outline:none;transition:border-color var(--tr)}
.comment-input:focus{border-color:var(--gold)}
.comment-input::placeholder{color:var(--smoke)}
.comment-send{background:none;border:1px solid var(--border);color:var(--ash);font-family:var(--font-body);font-size:11px;letter-spacing:.1em;padding:9px 16px;transition:all var(--tr);white-space:nowrap}
.comment-send:hover{border-color:var(--gold);color:var(--gold)}
/* ã‚³ãƒ¡ãƒ³ãƒˆæ¬„ã®ãƒ­ã‚°ã‚¤ãƒ³èª˜å° */
.comment-login-notice{font-size:11px;color:var(--smoke);letter-spacing:.08em;padding:10px 0;border-top:1px solid rgba(201,151,90,.08);margin-top:8px}
.comment-login-notice a{color:var(--gold);cursor:pointer;text-decoration:underline;text-underline-offset:2px}

/* â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#toast-container{position:fixed;bottom:28px;right:28px;z-index:5000;display:flex;flex-direction:column;gap:10px;pointer-events:none}
.toast{background:var(--ink-light);border:1px solid var(--border);padding:14px 20px;font-size:12px;letter-spacing:.06em;color:var(--paper);max-width:320px;pointer-events:all;animation:toast-in .3s ease}
.toast.success{border-left:3px solid var(--gold)}
.toast.error{border-left:3px solid var(--ember)}
@keyframes toast-in{from{transform:translateX(20px);opacity:0}to{transform:translateX(0);opacity:1}}
@keyframes toast-out{from{transform:translateX(0);opacity:1}to{transform:translateX(20px);opacity:0}}

/* â”€â”€ Footer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
footer{border-top:1px solid rgba(201,151,90,.12);padding:36px 20px;text-align:center;position:relative;z-index:10}
.footer-orn{font-size:11px;color:var(--smoke);margin-bottom:10px}
.footer-text{font-family:var(--font-en);font-style:italic;font-size:12px;color:var(--smoke);letter-spacing:.1em;line-height:2}

/* â”€â”€ Animations â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.fade-up{opacity:0;transform:translateY(16px);animation:fade-up-in .55s ease forwards}
@keyframes fade-up-in{to{opacity:1;transform:translateY(0)}}
.delay-1{animation-delay:.08s}.delay-2{animation-delay:.16s}.delay-3{animation-delay:.24s}
.delay-4{animation-delay:.32s}.delay-5{animation-delay:.40s}.delay-6{animation-delay:.48s}

/* â”€â”€ Responsive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@media(max-width:768px){
  #site-header{padding:60px 16px 44px}
  .stats-bar{flex-wrap:wrap}
  .stat-item{min-width:50%;border-bottom:1px solid rgba(201,151,90,.08)}
  #main-nav{flex-wrap:wrap}
  .nav-btn{min-width:50%;border-bottom:1px solid rgba(201,151,90,.08)}
}
@media(max-width:480px){
  .site-title{letter-spacing:.15em}
  .filter-bar{gap:4px}
  .filter-chip{font-size:10px;padding:5px 11px}
  .card-title{font-size:15px}
  .form-nav{flex-direction:column}
  .btn-prev{flex:none;width:100%}
  .ranking-full-num{font-size:28px;min-width:40px}
  .ranking-full-thumb{display:none}
}
</style>
</head>
<body>

<div id="particles"></div>

<!-- â”€â”€ AUTH BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="auth-bar">
  <div id="auth-loading"><div class="auth-skeleton"></div></div>
  <div id="auth-logged-out" style="display:none">
    <button class="auth-btn" onclick="loginWithTwitter()">
      <span>ğ•</span> <span data-t="loginBtn">Xï¼ˆTwitterï¼‰ã§ãƒ­ã‚°ã‚¤ãƒ³</span>
    </button>
  </div>
  <div id="auth-logged-in" style="display:none;align-items:center;gap:10px">
    <div class="auth-status-dot online"></div>
    <img id="auth-avatar" class="auth-avatar" src="" alt="">
    <span id="auth-display-name" class="auth-name"></span>
    <button class="auth-btn logout" onclick="logout()" data-t="logoutBtn">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
  </div>
</div>

<!-- â”€â”€ HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<header id="site-header">
  <div class="lang-switcher">
    <button class="lang-btn active" data-lang="ja" onclick="setLang('ja')">æ—¥æœ¬èª</button>
    <button class="lang-btn" data-lang="en" onclick="setLang('en')">EN</button>
  </div>
  <div class="header-ornament">
    <div class="orn-line orn-l"></div>
    <div class="orn-dot">âœ¦</div>
    <div class="orn-line orn-r"></div>
  </div>
  <h1 class="site-title" data-t="siteTitle">ã¿ã‹ã‚“å ‚</h1>
  <div class="site-title-en">Mikan Do</div>
  <p class="site-tagline" id="site-tagline">
    æ²¡ã«ãªã£ãŸã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¨­å®šãŸã¡ã®ã€å®‰ã‚‰ã‹ãªçœ ã‚Šã‚’ã€‚<br>
    ãƒ•ã‚¡ãƒ³ã®å£°ãŒã‚ã‚Œã°ã€ã„ã¤ã‹ã¾ãŸç›®è¦šã‚ã‚‹ã‹ã‚‚ã—ã‚Œãªã„ã€‚
  </p>
</header>

<!-- â”€â”€ STATS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="stats-bar">
  <div class="stat-item fade-up delay-1"><div class="stat-number" id="stat-posts">â€”</div><div class="stat-label" data-t="statPosts">ä¾›é¤Šã•ã‚ŒãŸè¨­å®š</div></div>
  <div class="stat-item fade-up delay-2"><div class="stat-number" id="stat-votes">â€”</div><div class="stat-label" data-t="statVotes">å¾©æ´»æŠ•ç¥¨æ•°</div></div>
  <div class="stat-item fade-up delay-3"><div class="stat-number" id="stat-creators">â€”</div><div class="stat-label" data-t="statCreators">å‚åŠ ã‚¯ãƒªã‚¨ã‚¤ã‚¿ãƒ¼</div></div>
  <div class="stat-item fade-up delay-4"><div class="stat-number" id="stat-hof">â€”</div><div class="stat-label" data-t="statHof">æ®¿å ‚å…¥ã‚Šå¾©æ´»æ¸ˆã¿</div></div>
</div>

<!-- â”€â”€ NAV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<nav id="main-nav">
  <button class="nav-btn active" data-t="navArchive" onclick="showSection('archive')">ğŸ“œ ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–</button>
  <button class="nav-btn" data-t="navRanking" onclick="showSection('ranking')">ğŸ”¥ å¾©æ´»ãƒ©ãƒ³ã‚­ãƒ³ã‚°</button>
  <button class="nav-btn" data-t="navPost" onclick="showSection('post')">ğŸ•¯ è¨­å®šã‚’ä¾›é¤Šã™ã‚‹</button>
  <button class="nav-btn" data-t="navHof" onclick="showSection('hof')">ğŸ‘‘ æ®¿å ‚å…¥ã‚Š</button>
</nav>

<!-- â”€â”€ MAIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<main id="main-content">

  <!-- ARCHIVE -->
  <section id="section-archive">
    <div class="layout-grid">
      <div>
        <div class="section-head fade-up">
          <span class="section-head-title" data-t="navArchive">ğŸ“œ ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–</span>
          <span class="section-head-sub">Botsu Archive</span>
          <div class="section-head-line"></div>
        </div>
        <div class="search-wrap fade-up delay-1">
          <span class="search-icon">ğŸ”</span>
          <input id="search-input" type="text" data-t-placeholder="searchPlaceholder" placeholder="ã‚¿ã‚¤ãƒˆãƒ«ãƒ»ã‚¯ãƒªã‚¨ã‚¤ã‚¿ãƒ¼åãƒ»ã‚¿ã‚°ã§æ¤œç´¢â€¦">
          <button class="search-clear" id="search-clear">âœ•</button>
        </div>
        <div class="filter-bar fade-up delay-2">
          <button class="filter-chip active" data-t="filterAll" onclick="setFilter(this,'all')">ã™ã¹ã¦</button>
          <button class="filter-chip" data-t="filterDesign" onclick="setFilter(this,'design')">ã‚­ãƒ£ãƒ©è¨­å®š</button>
          <button class="filter-chip" data-t="filterOutfit" onclick="setFilter(this,'outfit')">è¡£è£…æ¡ˆ</button>
          <button class="filter-chip" data-t="filterName" onclick="setFilter(this,'name')">ã‚­ãƒ£ãƒ©å</button>
          <button class="filter-chip" data-t="filterLore" onclick="setFilter(this,'lore')">ä¸–ç•Œè¦³ãƒ»è¨­å®š</button>
          <button class="filter-chip" data-t="filterBgm" onclick="setFilter(this,'bgm')">BGMæ¡ˆ</button>
        </div>
        <div class="sort-bar fade-up delay-2">
          <span class="sort-label">ä¸¦ã³æ›¿ãˆï¼š</span>
          <button class="sort-btn active" data-t="sortVotes" onclick="setSort(this,'votes')">æŠ•ç¥¨æ•°é †</button>
          <button class="sort-btn" data-t="sortDate" onclick="setSort(this,'date')">æ–°ç€é †</button>
          <button class="sort-btn" data-t="sortComments" onclick="setSort(this,'comments')">ã‚³ãƒ¡ãƒ³ãƒˆé †</button>
        </div>
        <div class="results-info" id="results-info"></div>
        <div id="cards-grid"></div>
      </div>
      <aside class="sidebar fade-up delay-3">
        <div class="sidebar-block">
          <div class="sidebar-title" data-t="rankingTitle">ğŸ”¥ ä»Šé€±ã®å¾©æ´»å€™è£œ</div>
          <div id="rank-sidebar"></div>
        </div>
        <div class="sidebar-block">
          <div class="sidebar-title">âœ¦ æœ€è¿‘ã®æ´»å‹•</div>
          <div id="activity-feed" style="font-size:11px;color:var(--ash);line-height:2.1;letter-spacing:.04em">
            <div>ğŸ•¯ <span style="color:var(--smoke)">èª­ã¿è¾¼ã¿ä¸­â€¦</span></div>
          </div>
        </div>
        <div class="sidebar-block">
          <div class="sidebar-title" data-t="weeklyTitle">ğŸ“… é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆ</div>
          <div style="font-size:12px;color:var(--ash);line-height:1.7;letter-spacing:.04em;margin-bottom:10px" data-t="weeklyDesc">ä»Šé€±ã®æ³¨ç›®æ²¡è¨­å®šã‚’ãƒ¡ãƒ¼ãƒ«ã§å—ã‘å–ã‚ã†</div>
          <div class="email-row">
            <input class="email-input" id="email-input" type="email" data-t-placeholder="weeklyPlaceholder" placeholder="your@email.com">
            <button class="email-btn" data-t="weeklyBtn" onclick="subscribeEmail()">ç™»éŒ²</button>
          </div>
        </div>
      </aside>
    </div>
  </section>

  <!-- RANKING -->
  <section id="section-ranking" style="display:none">
    <div class="ranking-page">
      <div class="ranking-hero fade-up">
        <div class="section-head-title" style="font-size:clamp(22px,4vw,36px);letter-spacing:.25em;color:var(--paper)" data-t="rankingPageTitle">å¾©æ´»ãƒ©ãƒ³ã‚­ãƒ³ã‚°</div>
        <div class="ranking-hero-sub" data-t="rankingHeroText">ç¥¨ã‚’é›†ã‚ãŸè¨­å®šãŒã€ã‚¯ãƒªã‚¨ã‚¤ã‚¿ãƒ¼ã®ç›®ã«å±Šãã€‚</div>
      </div>
      <div id="ranking-page-list"></div>
    </div>
  </section>

  <!-- POST FORM -->
  <section id="section-post" style="display:none">
    <div class="post-page">
      <div class="auth-gate" id="auth-gate">
        <div class="auth-gate-icon">ğŸ•¯</div>
        <div class="auth-gate-title" data-t="authGateTitle">ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™</div>
        <div class="auth-gate-text" data-t="authGateText">è¨­å®šã‚’ä¾›é¤Šã™ã‚‹ã«ã¯ã€Xï¼ˆTwitterï¼‰ã§ã®ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚<br>ãƒ•ã‚¡ãƒ³ã¨ã—ã¦ã®æŠ•ç¥¨ãƒ»ã‚³ãƒ¡ãƒ³ãƒˆã¯ãƒ­ã‚°ã‚¤ãƒ³ä¸è¦ã§è¡Œãˆã¾ã™ã€‚</div>
        <button class="twitter-login-btn" onclick="loginWithTwitter()">
          <span>ğ• ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ä¾›é¤Šã™ã‚‹</span>
        </button>
      </div>

      <div id="post-form-wrap" style="display:none">
        <div class="submit-success" id="submit-success">
          <div class="success-kanji">âœ¦</div>
          <div class="success-title" data-t="successTitle">ä¾›é¤ŠãŒå®Œäº†ã—ã¾ã—ãŸ</div>
          <div class="success-text" data-t="successText">ã‚ãªãŸã®è¨­å®šã¯ã€ã“ã“ã§å®‰ã‚‰ã‹ã«çœ ã‚Šã¾ã™ã€‚<br>ãƒ•ã‚¡ãƒ³ã®å£°ãŒã‚ã‚Œã°ã€ã„ã¤ã‹ã¾ãŸç›®è¦šã‚ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚</div>
          <button class="success-btn" data-t="backToArchive" onclick="showSection('archive')">ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã«æˆ»ã‚‹</button>
        </div>

        <div class="form-main" id="form-main">
          <div class="form-intro fade-up">
            <div class="form-intro-title" data-t="formTitle">è¨­å®šã‚’ä¾›é¤Šã™ã‚‹</div>
            <div class="form-intro-text">ãƒœãƒ„ã«ãªã£ãŸè¨­å®šãƒ»è¡£è£…æ¡ˆãƒ»åå‰ãƒ»ä¸–ç•Œè¦³â€¦â€¦<br>ã“ã“ã«è¨˜éŒ²ã™ã‚‹ã“ã¨ã§ã€ã„ã¤ã‹èª°ã‹ã®å¿ƒã«å±Šãã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚</div>
          </div>
          <div class="form-progress fade-up delay-1">
            <div class="progress-step active"><div class="progress-dot">1</div><div class="progress-label" data-t="step1">åŸºæœ¬æƒ…å ±</div></div>
            <div class="progress-step"><div class="progress-dot">2</div><div class="progress-label" data-t="step2">è©³ç´°</div></div>
            <div class="progress-step"><div class="progress-dot">3</div><div class="progress-label" data-t="step3">ç¢ºèª</div></div>
          </div>

          <!-- Step 1 -->
          <div class="form-panel active" id="form-step-1">
            <div class="form-group">
              <label class="form-label" for="f-title" data-t="labelTitle">è¨­å®šã®ã‚¿ã‚¤ãƒˆãƒ«<span class="form-required">ï¼Š</span></label>
              <input id="f-title" type="text" class="form-input" placeholder="ä¾‹ï¼šé—‡å •ã¡ver. / åˆæœŸãƒ‡ã‚¶ã‚¤ãƒ³ã€Œå¤œæ¡œã€ / ãƒœãƒ„åã€Œè™šãƒæœˆã€" oninput="clearFieldError('f-title','f-title-err')">
              <div class="form-error-msg" id="f-title-err"></div>
            </div>
            <div class="form-group">
              <label class="form-label" data-t="labelCat">ã‚«ãƒ†ã‚´ãƒª<span class="form-required">ï¼Š</span></label>
              <div class="cat-grid">
                <div><input type="radio" name="cat" id="cat-design" value="design" class="cat-radio" checked><label for="cat-design" class="cat-label" data-t="catDesign">ğŸ­ ã‚­ãƒ£ãƒ©è¨­å®šãƒ»ã‚³ãƒ³ã‚»ãƒ—ãƒˆ</label></div>
                <div><input type="radio" name="cat" id="cat-outfit" value="outfit" class="cat-radio"><label for="cat-outfit" class="cat-label" data-t="catOutfit">ğŸ‘— è¡£è£…ãƒ»ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«æ¡ˆ</label></div>
                <div><input type="radio" name="cat" id="cat-name" value="name" class="cat-radio"><label for="cat-name" class="cat-label" data-t="catName">âœï¸ ã‚­ãƒ£ãƒ©åãƒ»å‘¼ã³å</label></div>
                <div><input type="radio" name="cat" id="cat-lore" value="lore" class="cat-radio"><label for="cat-lore" class="cat-label" data-t="catLore">ğŸŒ™ ä¸–ç•Œè¦³ãƒ»ãƒãƒƒã‚¯ã‚¹ãƒˆãƒ¼ãƒªãƒ¼</label></div>
                <div><input type="radio" name="cat" id="cat-bgm" value="bgm" class="cat-radio"><label for="cat-bgm" class="cat-label" data-t="catBgm">ğŸµ BGMãƒ»æ¥½æ›²æ¡ˆ</label></div>
                <div><input type="radio" name="cat" id="cat-other" value="other" class="cat-radio"><label for="cat-other" class="cat-label" data-t="catOther">ğŸ“ ãã®ä»–</label></div>
              </div>
            </div>
            <div class="form-nav">
              <button id="btn-prev-1" class="btn-prev" style="display:none" onclick="prevStep()">â† æˆ»ã‚‹</button>
              <button class="btn-next" onclick="nextStep()"><span data-t="nextBtn">æ¬¡ã¸ â†’</span></button>
            </div>
          </div>

          <!-- Step 2 -->
          <div class="form-panel" id="form-step-2">
            <div class="form-group">
              <label class="form-label" for="f-reason" data-t="labelReason">ãªãœãƒœãƒ„ã«ãªã£ãŸã‹</label>
              <select id="f-reason" class="form-select">
                <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                <option>æ–¹å‘æ€§ãŒå¤‰ã‚ã£ã¦ã—ã¾ã£ãŸ</option><option>æ—¢å­˜ã‚­ãƒ£ãƒ©ã¨è¢«ã£ã¦ã—ã¾ã£ãŸ</option>
                <option>æŠ€è¡“çš„ã«å®Ÿç¾ã§ããªã‹ã£ãŸ</option><option>æ™‚æœŸãŒæ‚ªã‹ã£ãŸ</option>
                <option>å˜ç´”ã«è¿·ã£ã¦é¸ã°ãªã‹ã£ãŸ</option><option>ãã®ä»–</option>
              </select>
            </div>
            <!-- [FIX] descriptionï¼ˆè¦ç´„ï¼‰ã¨ full_descï¼ˆè©³ç´°ï¼‰ã‚’åˆ†ã‘ãŸ2ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«å¤‰æ›´ -->
            <div class="form-group">
              <label class="form-label" for="f-short-desc">ä¸€è¡Œç´¹ä»‹æ–‡<span class="form-required">ï¼Š</span></label>
              <input id="f-short-desc" type="text" class="form-input" maxlength="140"
                placeholder="ä¾‹ï¼šå’Œé¢¨ãƒ€ãƒ¼ã‚¯ç³»ã®é—‡å •ã¡Verã€‚æ²¡ã«ãªã£ãŸåˆæœŸã‚³ãƒ³ã‚»ãƒ—ãƒˆã€‚"
                oninput="clearFieldError('f-short-desc','f-short-desc-err');updateShortCounter()">
              <div class="char-counter" id="short-counter">0 / 140</div>
              <div class="form-error-msg" id="f-short-desc-err"></div>
              <div class="form-hint">ã‚«ãƒ¼ãƒ‰ã«è¡¨ç¤ºã•ã‚Œã‚‹ç´¹ä»‹æ–‡ã§ã™ï¼ˆ140å­—ä»¥å†…ï¼‰</div>
            </div>
            <div class="form-group">
              <label class="form-label" for="f-desc" data-t="labelDesc">è¨­å®šã®è©³ç´°<span class="form-required">ï¼Š</span></label>
              <textarea id="f-desc" class="form-textarea" placeholder="ã©ã‚“ãªè¨­å®šã ã£ãŸã‹ã€ã©ã‚“ãªæ€ã„ã§ä½œã£ãŸã‹ã€ã©ã†ã—ã¦ãƒœãƒ„ã«ã—ãŸã‹â€¦â€¦è‡ªç”±ã«æ›¸ã„ã¦ãã ã•ã„ã€‚" oninput="clearFieldError('f-desc','f-desc-err');updateFullCounter()"></textarea>
              <div class="char-counter" id="char-counter">0 / 2000</div>
              <div class="form-error-msg" id="f-desc-err"></div>
              <div class="form-hint" data-t="labelDescHint">ãƒ•ã‚¡ãƒ³ã¸ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ»è£è©±ãªã©ã‚‚æ­“è¿ã§ã™</div>
            </div>
            <div class="form-group">
              <label class="form-label" data-t="labelTags">ã‚¿ã‚°</label>
              <div class="tags-wrap" id="tags-wrap"><input type="text" class="tags-input" id="tags-input" placeholder="ä¾‹ï¼šãƒ€ãƒ¼ã‚¯ç³» å’Œé¢¨ é—‡å •ã¡"></div>
              <div class="form-hint" data-t="labelTagsHint">Enterã¾ãŸã¯ã‚¹ãƒšãƒ¼ã‚¹ã§è¿½åŠ ã€‚æœ€å¤§8å€‹ã€‚</div>
            </div>
            <div class="form-group">
              <label class="form-label" data-t="labelImage">ç”»åƒãƒ»è³‡æ–™ï¼ˆä»»æ„ï¼‰</label>
              <div class="upload-zone" id="upload-zone">
                <input type="file" id="f-image" accept="image/*" style="display:none">
                <div class="upload-icon">ğŸ–¼</div>
                <div class="upload-text">ã‚¯ãƒªãƒƒã‚¯ã¾ãŸã¯ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—<br><span style="color:var(--smoke);font-size:10px">PNG / JPG / GIF Â· æœ€å¤§10MB</span></div>
                <img class="upload-preview" id="upload-preview" alt="Preview">
                <div class="upload-filename" id="upload-filename"></div>
              </div>
            </div>
            <div class="form-nav">
              <button class="btn-prev" onclick="prevStep()" data-t="prevBtn">â† æˆ»ã‚‹</button>
              <button class="btn-next" onclick="nextStep()"><span data-t="nextBtn">æ¬¡ã¸ â†’</span></button>
            </div>
          </div>

          <!-- Step 3 -->
          <div class="form-panel" id="form-step-3">
            <div class="step-summary">
              <div class="step-summary-title" data-t="summaryTitle">å…¥åŠ›å†…å®¹ã®ç¢ºèª</div>
              <div class="summary-row"><div class="summary-key" data-t="summaryTitleLabel">ã‚¿ã‚¤ãƒˆãƒ«</div><div class="summary-val" id="summary-title-val">â€”</div></div>
              <div class="summary-row"><div class="summary-key" data-t="summaryCatLabel">ã‚«ãƒ†ã‚´ãƒª</div><div class="summary-val" id="summary-cat-val">â€”</div></div>
              <div class="summary-row"><div class="summary-key" data-t="summaryReasonLabel">ãƒœãƒ„ç†ç”±</div><div class="summary-val" id="summary-reason-val">â€”</div></div>
              <div class="summary-row"><div class="summary-key">ä¸€è¡Œç´¹ä»‹æ–‡</div><div class="summary-val" id="summary-short-val">â€”</div></div>
              <div class="summary-row"><div class="summary-key" data-t="summaryDescLabel">è©³ç´°</div><div class="summary-val" id="summary-desc-val">â€”</div></div>
              <div class="summary-row"><div class="summary-key" data-t="summaryTagsLabel">ã‚¿ã‚°</div><div class="summary-val" id="summary-tags-val">â€”</div></div>
            </div>
            <div class="form-nav">
              <button class="btn-prev" onclick="prevStep()" data-t="prevBtn">â† æˆ»ã‚‹</button>
              <button class="btn-submit" id="btn-submit" onclick="submitForm()"><span data-t="submitBtn">âœ¦ ã“ã®è¨­å®šã‚’ä¾›é¤Šã™ã‚‹ âœ¦</span></button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- HOF -->
  <section id="section-hof" style="display:none">
    <div class="hof-page">
      <div class="hof-hero fade-up">
        <div class="hof-hero-title" data-t="hofTitle">æ®¿å ‚å…¥ã‚Š</div>
        <div class="hof-hero-text" data-t="hofSubtitle">Fan voices brought them back to life.</div>
      </div>
      <div id="hof-list"></div>
    </div>
  </section>
</main>

<footer>
  <div class="footer-orn">âœ¦</div>
  <div class="footer-text">ã¿ã‹ã‚“å ‚ â€” Mikan Do<br><span style="font-size:11px;opacity:.5">æ²¡ã«ãªã£ãŸè¨­å®šã«ã€æ–°ã—ã„å‘½ã‚’ã€‚New life for discarded concepts.</span></div>
</footer>

<div id="modal-overlay">
  <div class="modal">
    <button class="modal-close" onclick="closeModal()">âœ•</button>
    <div id="modal-body"></div>
  </div>
</div>
<div id="toast-container"></div>

<script>
'use strict';

/* â”€â”€ Supabase config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const SUPABASE_URL      = 'https://hgxvgxjngddyjnwdlanq.supabase.co';
const SUPABASE_ANON_KEY = 'sb_publishable_nCeYKls8EqFiIx1NZz64fA_yXIEvO4Z';
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const state = {
  lang: 'ja',
  section: 'archive',
  filter: 'all',
  sort: 'votes',
  query: '',
  user: null,
  profile: null,
  voted: new Set(),
  anonVoted: new Set(),   // [FIX] ã‚¢ãƒãƒ‹ãƒã‚¹æŠ•ç¥¨ã‚’stateã§ç®¡ç†
  posts: [],
  formStep: 1,
  tags: [],
  formData: {},
  uploadFile: null,
  realtimeChannel: null,  // [FIX] ãƒãƒ£ãƒ³ãƒãƒ«å‚ç…§ã‚’ä¿æŒã—ã¦ãƒ€ãƒ–ãƒ«ç™»éŒ²é˜²æ­¢
};

/* â”€â”€ Translations â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const T = {
  ja:{
    siteTitle:'ã¿ã‹ã‚“å ‚',tagline:'æ²¡ã«ãªã£ãŸã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¨­å®šãŸã¡ã®ã€å®‰ã‚‰ã‹ãªçœ ã‚Šã‚’ã€‚\nãƒ•ã‚¡ãƒ³ã®å£°ãŒã‚ã‚Œã°ã€ã„ã¤ã‹ã¾ãŸç›®è¦šã‚ã‚‹ã‹ã‚‚ã—ã‚Œãªã„ã€‚',
    loginBtn:'Xï¼ˆTwitterï¼‰ã§ãƒ­ã‚°ã‚¤ãƒ³',logoutBtn:'ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ',
    authGateTitle:'ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™',authGateText:'è¨­å®šã‚’ä¾›é¤Šã™ã‚‹ã«ã¯ã€Xï¼ˆTwitterï¼‰ã§ã®ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚\nãƒ•ã‚¡ãƒ³ã¨ã—ã¦ã®æŠ•ç¥¨ãƒ»ã‚³ãƒ¡ãƒ³ãƒˆã¯ãƒ­ã‚°ã‚¤ãƒ³ä¸è¦ã§è¡Œãˆã¾ã™ã€‚',
    statPosts:'ä¾›é¤Šã•ã‚ŒãŸè¨­å®š',statVotes:'å¾©æ´»æŠ•ç¥¨æ•°',statCreators:'å‚åŠ ã‚¯ãƒªã‚¨ã‚¤ã‚¿ãƒ¼',statHof:'æ®¿å ‚å…¥ã‚Šå¾©æ´»æ¸ˆã¿',
    navArchive:'ğŸ“œ ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–',navRanking:'ğŸ”¥ å¾©æ´»ãƒ©ãƒ³ã‚­ãƒ³ã‚°',navPost:'ğŸ•¯ è¨­å®šã‚’ä¾›é¤Šã™ã‚‹',navHof:'ğŸ‘‘ æ®¿å ‚å…¥ã‚Š',
    filterAll:'ã™ã¹ã¦',filterDesign:'ã‚­ãƒ£ãƒ©è¨­å®š',filterOutfit:'è¡£è£…æ¡ˆ',filterName:'ã‚­ãƒ£ãƒ©å',filterLore:'ä¸–ç•Œè¦³ãƒ»è¨­å®š',filterBgm:'BGMæ¡ˆ',
    sortVotes:'æŠ•ç¥¨æ•°é †',sortDate:'æ–°ç€é †',sortComments:'ã‚³ãƒ¡ãƒ³ãƒˆé †',
    revive:'å¾©æ´»ã‚’æœ›ã‚€',voted:'æŠ•ç¥¨æ¸ˆã¿',
    searchPlaceholder:'ã‚¿ã‚¤ãƒˆãƒ«ãƒ»ã‚¯ãƒªã‚¨ã‚¤ã‚¿ãƒ¼åãƒ»ã‚¿ã‚°ã§æ¤œç´¢â€¦',
    results:(n)=>`${n}ä»¶ã®è¨­å®š`,noResults:'è©²å½“ã™ã‚‹è¨­å®šãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ',noResultsSub:'ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰ãˆã¦ãŠè©¦ã—ãã ã•ã„',
    catDesign:'ğŸ­ ã‚­ãƒ£ãƒ©è¨­å®šãƒ»ã‚³ãƒ³ã‚»ãƒ—ãƒˆ',catOutfit:'ğŸ‘— è¡£è£…ãƒ»ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«æ¡ˆ',catName:'âœï¸ ã‚­ãƒ£ãƒ©åãƒ»å‘¼ã³å',catLore:'ğŸŒ™ ä¸–ç•Œè¦³ãƒ»ãƒãƒƒã‚¯ã‚¹ãƒˆãƒ¼ãƒªãƒ¼',catBgm:'ğŸµ BGMãƒ»æ¥½æ›²æ¡ˆ',catOther:'ğŸ“ ãã®ä»–',
    reasons:['æ–¹å‘æ€§ãŒå¤‰ã‚ã£ã¦ã—ã¾ã£ãŸ','æ—¢å­˜ã‚­ãƒ£ãƒ©ã¨è¢«ã£ã¦ã—ã¾ã£ãŸ','æŠ€è¡“çš„ã«å®Ÿç¾ã§ããªã‹ã£ãŸ','æ™‚æœŸãŒæ‚ªã‹ã£ãŸ','å˜ç´”ã«è¿·ã£ã¦é¸ã°ãªã‹ã£ãŸ','ãã®ä»–'],
    step1:'åŸºæœ¬æƒ…å ±',step2:'è©³ç´°',step3:'ç¢ºèª',
    formTitle:'è¨­å®šã‚’ä¾›é¤Šã™ã‚‹',labelTitle:'è¨­å®šã®ã‚¿ã‚¤ãƒˆãƒ«',labelCat:'ã‚«ãƒ†ã‚´ãƒª',labelReason:'ãªãœãƒœãƒ„ã«ãªã£ãŸã‹',labelDesc:'è¨­å®šã®è©³ç´°',
    labelDescHint:'ãƒ•ã‚¡ãƒ³ã¸ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ»è£è©±ãªã©ã‚‚æ­“è¿ã§ã™',labelTags:'ã‚¿ã‚°',labelTagsHint:'Enterã¾ãŸã¯ã‚¹ãƒšãƒ¼ã‚¹ã§è¿½åŠ ã€‚æœ€å¤§8å€‹ã€‚',labelImage:'ç”»åƒãƒ»è³‡æ–™ï¼ˆä»»æ„ï¼‰',
    prevBtn:'â† æˆ»ã‚‹',nextBtn:'æ¬¡ã¸ â†’',submitBtn:'âœ¦ ã“ã®è¨­å®šã‚’ä¾›é¤Šã™ã‚‹ âœ¦',
    summaryTitle:'å…¥åŠ›å†…å®¹ã®ç¢ºèª',summaryTitleLabel:'ã‚¿ã‚¤ãƒˆãƒ«',summaryCatLabel:'ã‚«ãƒ†ã‚´ãƒª',summaryReasonLabel:'ãƒœãƒ„ç†ç”±',summaryDescLabel:'è©³ç´°',summaryTagsLabel:'ã‚¿ã‚°',
    successTitle:'ä¾›é¤ŠãŒå®Œäº†ã—ã¾ã—ãŸ',successText:'ã‚ãªãŸã®è¨­å®šã¯ã€ã“ã“ã§å®‰ã‚‰ã‹ã«çœ ã‚Šã¾ã™ã€‚\nãƒ•ã‚¡ãƒ³ã®å£°ãŒã‚ã‚Œã°ã€ã„ã¤ã‹ã¾ãŸç›®è¦šã‚ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚',backToArchive:'ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã«æˆ»ã‚‹',
    modalVoteText:'ã“ã®è¨­å®šã®å¾©æ´»ã‚’æœ›ã¿ã¾ã™ã‹ï¼Ÿ\nã‚ãªãŸã®ä¸€ç¥¨ãŒã‚¯ãƒªã‚¨ã‚¤ã‚¿ãƒ¼ã¸ã®å£°ã«ãªã‚Šã¾ã™ã€‚',
    commentsTitle:(n)=>`ãƒ•ã‚¡ãƒ³ã®ã‚³ãƒ¡ãƒ³ãƒˆ (${n})`,
    commentPlaceholder:'ã€Œã‚‚ã—å¾©æ´»ã—ãŸã‚‰ã€‡ã€‡ã—ãŸã„ã€ãªã©â€¦',commentSend:'é€ã‚‹',
    commentLoginNotice:'ã‚³ãƒ¡ãƒ³ãƒˆã™ã‚‹ã«ã¯ <a onclick="loginWithTwitter()">ãƒ­ã‚°ã‚¤ãƒ³</a> ã—ã¦ãã ã•ã„',
    rankingTitle:'ä»Šé€±ã®å¾©æ´»å€™è£œ',rankingPageTitle:'å¾©æ´»ãƒ©ãƒ³ã‚­ãƒ³ã‚°',rankingHeroText:'ç¥¨ã‚’é›†ã‚ãŸè¨­å®šãŒã€ã‚¯ãƒªã‚¨ã‚¤ã‚¿ãƒ¼ã®ç›®ã«å±Šãã€‚',
    hofTitle:'æ®¿å ‚å…¥ã‚Š',hofSubtitle:'Fan voices brought them back to life.',hofRevived:'å¾©æ´»æ¸ˆã¿',
    weeklyTitle:'ğŸ“… é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆ',weeklyDesc:'ä»Šé€±ã®æ³¨ç›®æ²¡è¨­å®šã‚’ãƒ¡ãƒ¼ãƒ«ã§å—ã‘å–ã‚ã†',weeklyBtn:'ç™»éŒ²',weeklyPlaceholder:'your@email.com',
    titleRequired:'ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„',shortDescRequired:'ä¸€è¡Œç´¹ä»‹æ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆ10å­—ä»¥ä¸Šï¼‰',descRequired:'è©³ç´°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆ10æ–‡å­—ä»¥ä¸Šï¼‰',
    toastVoted:'ğŸ•¯ å¾©æ´»ã‚’æœ›ã‚€ç¥¨ã‚’æŠ•ã˜ã¾ã—ãŸ',toastUnvoted:'ç¥¨ã‚’å–ã‚Šæ¶ˆã—ã¾ã—ãŸ',
    toastSubmitted:'âœ¦ ä¾›é¤ŠãŒå®Œäº†ã—ã¾ã—ãŸ',toastCommented:'ã‚³ãƒ¡ãƒ³ãƒˆã‚’é€ã‚Šã¾ã—ãŸ',toastEmail:'ç™»éŒ²ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™',
    toastLoginRequired:'ã‚³ãƒ¡ãƒ³ãƒˆã™ã‚‹ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„',toastError:'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãã—ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚',
    toastUploading:'ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­â€¦',loading:'èª­ã¿è¾¼ã¿ä¸­â€¦',
  },
  en:{
    siteTitle:'Mikan Do',tagline:'A resting place for discarded character concepts.\nWith enough love from fans, they may yet awaken.',
    loginBtn:'Sign in with X (Twitter)',logoutBtn:'Sign out',
    authGateTitle:'Login required',authGateText:'Signing in with X (Twitter) is required to submit a concept.\nVoting and commenting are available without logging in.',
    statPosts:'Archived Concepts',statVotes:'Revival Votes',statCreators:'Creators',statHof:'Revived',
    navArchive:'ğŸ“œ Archive',navRanking:'ğŸ”¥ Revival Ranking',navPost:'ğŸ•¯ Submit a Concept',navHof:'ğŸ‘‘ Hall of Fame',
    filterAll:'All',filterDesign:'Concept',filterOutfit:'Outfit',filterName:'Name',filterLore:'Lore',filterBgm:'BGM',
    sortVotes:'Most Voted',sortDate:'Newest',sortComments:'Most Comments',
    revive:'Revive',voted:'Voted',
    searchPlaceholder:'Search by title, creator, or tagâ€¦',
    results:(n)=>`${n} concepts`,noResults:'No concepts found',noResultsSub:'Try different keywords',
    catDesign:'ğŸ­ Character Concept',catOutfit:'ğŸ‘— Outfit / Visual',catName:'âœï¸ Name / Alias',catLore:'ğŸŒ™ Lore / Backstory',catBgm:'ğŸµ BGM / Music',catOther:'ğŸ“ Other',
    reasons:['Direction changed','Too similar to existing','Not technically feasible','Bad timing','Simply couldn\'t decide','Other'],
    step1:'Basic Info',step2:'Details',step3:'Confirm',
    formTitle:'Submit a Concept',labelTitle:'Concept Title',labelCat:'Category',labelReason:'Why Discarded',labelDesc:'Details',
    labelDescHint:'Behind-the-scenes notes and messages to fans are welcome',labelTags:'Tags',labelTagsHint:'Press Enter or Space. Max 8 tags.',labelImage:'Image / Reference (optional)',
    prevBtn:'â† Back',nextBtn:'Next â†’',submitBtn:'âœ¦ Submit This Concept âœ¦',
    summaryTitle:'Review Your Submission',summaryTitleLabel:'Title',summaryCatLabel:'Category',summaryReasonLabel:'Reason',summaryDescLabel:'Details',summaryTagsLabel:'Tags',
    successTitle:'Successfully Archived',successText:'Your concept rests peacefully here.\nWith enough love from fans, it may yet awaken.',backToArchive:'Back to Archive',
    modalVoteText:'Want this concept to be revived?\nYour vote sends a message to the creator.',
    commentsTitle:(n)=>`Fan Comments (${n})`,
    commentPlaceholder:'"I\'d love to see this revived forâ€¦"',commentSend:'Post',
    commentLoginNotice:'<a onclick="loginWithTwitter()">Sign in</a> to leave a comment',
    rankingTitle:'This Week\'s Top',rankingPageTitle:'Revival Ranking',rankingHeroText:'The most-voted concepts are seen by creators.',
    hofTitle:'Hall of Fame',hofSubtitle:'Fan voices brought them back to life.',hofRevived:'Revived',
    weeklyTitle:'ğŸ“… Weekly Report',weeklyDesc:'Get top concepts in your inbox weekly',weeklyBtn:'Join',weeklyPlaceholder:'your@email.com',
    titleRequired:'Please enter a title',shortDescRequired:'Please enter a short description (10+ characters)',descRequired:'Please enter details (at least 10 characters)',
    toastVoted:'ğŸ•¯ Revival vote cast',toastUnvoted:'Vote removed',
    toastSubmitted:'âœ¦ Concept successfully archived',toastCommented:'Comment posted',toastEmail:'Thanks for subscribing!',
    toastLoginRequired:'Please log in to comment',toastError:'Something went wrong. Please try again.',
    toastUploading:'Uploading imageâ€¦',loading:'Loadingâ€¦',
  }
};
const t = () => T[state.lang];

const catLabels = {design:{ja:'ã‚­ãƒ£ãƒ©è¨­å®š',en:'Concept'},outfit:{ja:'è¡£è£…æ¡ˆ',en:'Outfit'},name:{ja:'ã‚­ãƒ£ãƒ©å',en:'Name'},lore:{ja:'ä¸–ç•Œè¦³',en:'Lore'},bgm:{ja:'BGMæ¡ˆ',en:'BGM'},other:{ja:'ãã®ä»–',en:'Other'}};
const catLabel = cat => catLabels[cat]?.[state.lang] || cat;
const esc = s => String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
const relTime = iso => {
  const s = (Date.now() - new Date(iso)) / 1000;
  if (s < 60)    return state.lang==='ja' ? 'ãŸã£ãŸä»Š'          : 'just now';
  if (s < 3600)  return state.lang==='ja' ? `${Math.floor(s/60)}åˆ†å‰`    : `${Math.floor(s/60)}m ago`;
  if (s < 86400) return state.lang==='ja' ? `${Math.floor(s/3600)}æ™‚é–“å‰` : `${Math.floor(s/3600)}h ago`;
  return state.lang==='ja' ? `${Math.floor(s/86400)}æ—¥å‰` : `${Math.floor(s/86400)}d ago`;
};

/* â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function showToast(msg, type='success') {
  const c = document.getElementById('toast-container');
  const el = document.createElement('div');
  el.className = `toast ${type}`;
  el.textContent = msg;
  c.appendChild(el);
  setTimeout(() => { el.style.animation = 'toast-out .3s ease forwards'; setTimeout(() => el.remove(), 300); }, 2800);
}

/* â”€â”€ Particles â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function initParticles() {
  const c = document.getElementById('particles');
  for (let i = 0; i < 22; i++) {
    const p = document.createElement('div');
    p.className = 'particle';
    const sz = 1.2 + Math.random() * 2.5;
    p.style.cssText = `left:${Math.random()*100}%;width:${sz}px;height:${sz}px;background:${Math.random()>.6?'var(--gold)':'var(--ember)'};--d:${(Math.random()-.5)*100}px;animation-duration:${7+Math.random()*10}s;animation-delay:${Math.random()*12}s;`;
    c.appendChild(p);
  }
}

/* â”€â”€ Auth â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function initAuth() {
  // [FIX] Promiseã§è§£æ±ºã—ã¦ã‹ã‚‰å‘¼ã³å‡ºã—å…ƒã«è¿”ã™ï¼ˆloadVotedPostsã¨ã®ç«¶åˆé˜²æ­¢ï¼‰
  return new Promise(async (resolve) => {
    const { data: { session } } = await sb.auth.getSession();
    onAuthChange(session?.user ?? null);
    if (session?.user) await loadVotedPosts();
    resolve();

    sb.auth.onAuthStateChange(async (_event, session) => {
      onAuthChange(session?.user ?? null);
      if (session?.user) await loadVotedPosts();
      else { state.voted.clear(); renderCards(); }
    });
  });
}

function onAuthChange(user) {
  state.user = user;
  const loading   = document.getElementById('auth-loading');
  const loggedOut = document.getElementById('auth-logged-out');
  const loggedIn  = document.getElementById('auth-logged-in');

  loading.style.display = 'none';
  if (user) {
    const meta = user.user_metadata;
    document.getElementById('auth-avatar').src = meta.avatar_url || '';
    document.getElementById('auth-display-name').textContent = meta.full_name || meta.user_name || '';
    loggedIn.style.display  = 'flex';
    loggedOut.style.display = 'none';
  } else {
    loggedIn.style.display  = 'none';
    loggedOut.style.display = 'flex';
  }
  if (state.section === 'post') showPostSection();
}

async function loginWithTwitter() {
  const { error } = await sb.auth.signInWithOAuth({
    provider: 'twitter',
    options: { redirectTo: location.href }
  });
  if (error) showToast(t().toastError, 'error');
}

async function logout() {
  await sb.auth.signOut();
  state.user = null;
  state.voted.clear();
  showToast(state.lang === 'ja' ? 'ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ' : 'Signed out');
}

/* â”€â”€ Load voted posts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function loadVotedPosts() {
  if (!state.user) return;
  const { data } = await sb.from('votes').select('post_id').eq('user_id', state.user.id);
  state.voted = new Set((data || []).map(v => v.post_id));
  // ã‚¢ãƒãƒ‹ãƒã‚¹æŠ•ç¥¨ã‚‚LocalStorageã‹ã‚‰å¾©å…ƒ
  state.anonVoted = new Set(JSON.parse(localStorage.getItem('kuyo_anon_votes') || '[]'));
}

/* â”€â”€ Fetch posts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function fetchPosts() {
  showSkeletons();
  let q = sb.from('posts')
    .select(`*, profiles(username, display_name, avatar_url)`)
    .eq('is_hof', false);

  if (state.filter !== 'all') q = q.eq('category', state.filter);

  // [FIX] FTSã¯ã‚«ãƒ©ãƒ åã§ã¯ãªã ilike ã§ title/description/tags ã‚’æ¨ªæ–­æ¤œç´¢
  if (state.query) {
    const kw = `%${state.query}%`;
    q = q.or(`title.ilike.${kw},description.ilike.${kw}`);
  }

  if (state.sort === 'votes')    q = q.order('vote_count',    { ascending: false });
  if (state.sort === 'date')     q = q.order('created_at',    { ascending: false });
  if (state.sort === 'comments') q = q.order('comment_count', { ascending: false });

  q = q.limit(40);

  const { data, error } = await q;
  if (error) { showToast(t().toastError, 'error'); return; }
  state.posts = data || [];
  renderCards();
  renderRankingSidebar();
  renderStats();
  renderActivityFeed();
}

/* â”€â”€ Render stats â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function renderStats() {
  const { count: postCount } = await sb.from('posts').select('id', { count:'exact', head:true }).eq('is_hof', false);
  const { count: hofCount }  = await sb.from('posts').select('id', { count:'exact', head:true }).eq('is_hof', true);
  const { count: creatorCount } = await sb.from('profiles').select('id', { count:'exact', head:true });

  // [FIX] å…¨ä»¶å–å¾—ã§ã¯ãªãé›†è¨ˆã‚¯ã‚¨ãƒªã§åˆè¨ˆç¥¨æ•°ã‚’å–å¾—
  const { data: voteAgg } = await sb.rpc('get_total_votes').maybeSingle();
  const totalVotes = voteAgg?.total ?? 0;

  document.getElementById('stat-posts').textContent    = postCount     ?? 'â€”';
  document.getElementById('stat-votes').textContent    = Number(totalVotes).toLocaleString();
  document.getElementById('stat-creators').textContent = creatorCount  ?? 'â€”';
  document.getElementById('stat-hof').textContent      = hofCount      ?? 'â€”';
}

/* â”€â”€ Activity feed â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function renderActivityFeed() {
  const { data } = await sb.from('posts')
    .select('title, created_at, profiles(display_name)')
    .eq('is_hof', false)
    .order('created_at', { ascending: false })
    .limit(5);

  const feed = document.getElementById('activity-feed');
  if (!data || !data.length) { feed.innerHTML = ''; return; }
  feed.innerHTML = data.map(p => `
    <div style="font-size:11px;color:var(--ash);line-height:2.1;letter-spacing:.04em">
      ğŸ•¯ <span style="color:var(--smoke)">${relTime(p.created_at)}</span>
      â€” ${esc(p.profiles?.display_name || 'åŒ¿å')} ãŒä¾›é¤Š
    </div>`).join('');
}

/* â”€â”€ Render cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function showSkeletons() {
  document.getElementById('cards-grid').innerHTML = Array(6).fill('').map(() => `
    <div class="card-skeleton">
      <div class="skel-thumb"></div>
      <div class="skel-line" style="height:14px;width:60%"></div>
      <div class="skel-line" style="height:10px;width:40%"></div>
      <div class="skel-line" style="height:10px;width:90%"></div>
      <div class="skel-line" style="height:10px;width:75%"></div>
    </div>`).join('');
}

function renderCards() {
  const grid  = document.getElementById('cards-grid');
  const info  = document.getElementById('results-info');
  const posts = state.posts;
  info.textContent = t().results(posts.length);

  if (!posts.length) {
    grid.innerHTML = `<div class="empty-state"><div class="empty-kanji">æ²¡</div><div class="empty-text">${esc(t().noResults)}<br><span style="font-size:11px;opacity:.6">${esc(t().noResultsSub)}</span></div></div>`;
    return;
  }

  grid.innerHTML = posts.map((p, i) => {
    const creator  = p.profiles?.display_name || p.profiles?.username || 'â€”';
    const initials = creator[0] || 'åŒ¿';
    // [FIX] ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ã¯state.votedã€æœªãƒ­ã‚°ã‚¤ãƒ³ã¯state.anonVotedã§åˆ¤å®š
    const voted    = state.voted.has(p.id) || state.anonVoted.has(p.id);
    return `
      <div class="botsu-card fade-up delay-${Math.min(i%6+1,6)}" data-id="${esc(p.id)}" onclick="openModal('${esc(p.id)}')">
        ${p.is_hof ? '<div class="card-hof">æ®¿å ‚å…¥ã‚Š</div>' : ''}
        <div class="card-badge"><div class="badge-dot ${esc(p.category)}"></div>${esc(catLabel(p.category))}</div>
        <div class="card-title">${esc(p.title)}</div>
        <div class="card-creator">
          <div class="avatar avatar-sm" style="background:linear-gradient(135deg,var(--ember),var(--gold))">${esc(initials)}</div>
          <div class="creator-name">${esc(creator)}</div>
        </div>
        <div class="card-thumb">
          ${p.image_url ? `<img src="${esc(p.image_url)}" alt="${esc(p.title)}" loading="lazy">` : '<div class="card-thumb-kanji">æ²¡</div>'}
        </div>
        <div class="card-desc">${esc(p.description)}</div>
        <div class="card-footer">
          <button class="vote-btn ${voted?'voted':''}" onclick="event.stopPropagation();castVote('${esc(p.id)}')">
            ğŸ•¯ <span class="vote-num" id="vn-${esc(p.id)}">${p.vote_count}</span>
            <span id="vl-${esc(p.id)}">${voted ? esc(t().voted) : esc(t().revive)}</span>
          </button>
          <div class="card-date">${new Date(p.created_at).toLocaleDateString('ja-JP').replace(/\//g,'.')}</div>
        </div>
      </div>`;
  }).join('');
}

/* â”€â”€ Ranking sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function renderRankingSidebar() {
  const { data } = await sb.from('posts')
    .select('id, title, vote_count, profiles(display_name,username)')
    .eq('is_hof', false)
    .order('vote_count', { ascending: false })
    .limit(5);

  const list = document.getElementById('rank-sidebar');
  if (!data) return;
  list.innerHTML = data.map((p, i) => {
    const cls     = i===0?'gold':i===1?'silver':i===2?'bronze':'';
    const creator = p.profiles?.display_name || p.profiles?.username || 'â€”';
    return `<div class="rank-item" onclick="openModal('${esc(p.id)}')">
      <div class="rank-num ${cls}">${i+1}</div>
      <div class="rank-info">
        <div class="rank-title-text">${esc(p.title)}</div>
        <div class="rank-creator-text">${esc(creator)}</div>
      </div>
      <div class="rank-votes">${p.vote_count}</div>
    </div>`;
  }).join('');
}

/* â”€â”€ Ranking page â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function renderRankingPage() {
  const { data } = await sb.from('posts')
    .select('*, profiles(display_name,username,avatar_url)')
    .eq('is_hof', false)
    .order('vote_count', { ascending: false })
    .limit(50);

  const list = document.getElementById('ranking-page-list');
  if (!data) return;
  list.innerHTML = data.map((p, i) => {
    const cls     = i===0?'gold':i===1?'silver':i===2?'bronze':'';
    const creator = p.profiles?.display_name || p.profiles?.username || 'â€”';
    const initials = creator[0] || 'åŒ¿';
    return `<div class="ranking-full-item" onclick="openModal('${esc(p.id)}')">
      <div class="ranking-full-num ${cls}">${i+1}</div>
      <div class="ranking-full-thumb">
        ${p.image_url ? `<img src="${esc(p.image_url)}" alt="">` : 'æ²¡'}
      </div>
      <div class="ranking-full-info">
        <div class="ranking-full-title">${esc(p.title)}</div>
        <div class="ranking-full-creator">
          <div class="avatar avatar-sm" style="background:linear-gradient(135deg,var(--ember),var(--gold))">${esc(initials)}</div>
          <div class="creator-name">${esc(creator)}</div>
        </div>
        <div class="ranking-full-desc">${esc(p.description)}</div>
      </div>
      <div class="ranking-full-votes">
        ${p.vote_count}<small>${state.lang==='ja'?'ç¥¨':'votes'}</small>
      </div>
    </div>`;
  }).join('');
}

/* â”€â”€ HoF â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function renderHof() {
  const { data } = await sb.from('posts')
    .select('*, profiles(display_name,username)')
    .eq('is_hof', true)
    .order('vote_count', { ascending: false });

  const list = document.getElementById('hof-list');
  if (!data || !data.length) {
    list.innerHTML = `<div class="empty-state"><div class="empty-kanji">âœ¦</div><div class="empty-text">${state.lang==='ja'?'ã¾ã æ®¿å ‚å…¥ã‚Šã¯ã‚ã‚Šã¾ã›ã‚“':'No Hall of Fame entries yet'}</div></div>`;
    return;
  }
  list.innerHTML = data.map(p => {
    const creator = p.profiles?.display_name || p.profiles?.username || 'â€”';
    return `<div class="hof-card fade-up">
      <div class="hof-badge">ğŸ‘‘ ${esc(t().hofRevived)}</div>
      <div class="hof-title">${esc(p.title)}</div>
      <div style="font-size:12px;color:var(--ash);letter-spacing:.04em">${esc(creator)}</div>
      <div class="hof-story">${esc(p.full_desc)}</div>
      <div class="hof-votes"><div class="hof-votes-num">${p.vote_count}</div><div class="hof-votes-label">${state.lang==='ja'?'ç¥¨ã®æ”¯æŒ':'votes of support'}</div></div>
    </div>`;
  }).join('');
}

/* â”€â”€ Vote â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function castVote(postId) {
  const isLoggedIn  = !!state.user;
  const isVotedAuth = isLoggedIn && state.voted.has(postId);
  const isVotedAnon = !isLoggedIn && state.anonVoted.has(postId);

  if (isVotedAuth) {
    // å–ã‚Šæ¶ˆã—ï¼ˆãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ï¼‰
    const { error } = await sb.from('votes')
      .delete().eq('post_id', postId).eq('user_id', state.user.id);
    if (error) { showToast(t().toastError, 'error'); return; }
    state.voted.delete(postId);
    updateVoteDOM(postId, -1, false);
    showToast(t().toastUnvoted, 'error');

  } else if (isVotedAnon) {
    // å–ã‚Šæ¶ˆã—ï¼ˆæœªãƒ­ã‚°ã‚¤ãƒ³ â€” ãƒ­ãƒ¼ã‚«ãƒ«ã®ã¿ï¼‰
    state.anonVoted.delete(postId);
    localStorage.setItem('kuyo_anon_votes', JSON.stringify([...state.anonVoted]));
    updateVoteDOM(postId, -1, false);
    showToast(t().toastUnvoted, 'error');

  } else if (isLoggedIn) {
    // æŠ•ç¥¨ï¼ˆãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ï¼‰
    const { error } = await sb.from('votes').insert({ post_id: postId, user_id: state.user.id });
    if (error) { showToast(t().toastError, 'error'); return; }
    state.voted.add(postId);
    updateVoteDOM(postId, 1, true);
    showToast(t().toastVoted);
    spawnParticles(postId);

  } else {
    // æŠ•ç¥¨ï¼ˆæœªãƒ­ã‚°ã‚¤ãƒ³ â€” ãƒ­ãƒ¼ã‚«ãƒ«ã®ã¿ï¼‰
    state.anonVoted.add(postId);
    localStorage.setItem('kuyo_anon_votes', JSON.stringify([...state.anonVoted]));
    updateVoteDOM(postId, 1, true);
    showToast(t().toastVoted);
    spawnParticles(postId);
  }

  renderRankingSidebar();
}

function updateVoteDOM(postId, delta, isVoted) {
  // ã‚«ãƒ¼ãƒ‰ä¸Š
  const vn = document.getElementById(`vn-${postId}`);
  if (vn) vn.textContent = Math.max(0, parseInt(vn.textContent || 0) + delta);
  const vl = document.getElementById(`vl-${postId}`);
  if (vl) vl.textContent = isVoted ? t().voted : t().revive;
  const btn = vn?.closest('.vote-btn');
  if (btn) btn.classList.toggle('voted', isVoted);
  // ãƒ¢ãƒ¼ãƒ€ãƒ«ä¸Š
  const mvn = document.getElementById('modal-vote-num');
  if (mvn) mvn.textContent = Math.max(0, parseInt(mvn.textContent || 0) + delta);
  const mvb = document.getElementById('modal-vote-btn');
  if (mvb) {
    mvb.classList.toggle('voted', isVoted);
    const lbl = mvb.querySelector('.mvb-label');
    if (lbl) lbl.textContent = isVoted ? t().voted : t().revive;
  }
}

function spawnParticles(id) {
  const card = document.querySelector(`[data-id="${id}"]`);
  const btn  = card?.querySelector('.vote-btn');
  if (!btn) return;
  const r = btn.getBoundingClientRect();
  for (let i = 0; i < 8; i++) {
    const s = document.createElement('div');
    const a = (i / 8) * Math.PI * 2;
    s.style.cssText = `position:fixed;left:${r.left+r.width/2}px;top:${r.top+r.height/2}px;width:4px;height:4px;background:${i%2?'var(--gold)':'var(--ember)'};border-radius:50%;pointer-events:none;z-index:9000;transform:translate(-50%,-50%);transition:transform .6s cubic-bezier(.2,1,.3,1),opacity .6s ease;`;
    document.body.appendChild(s);
    requestAnimationFrame(() => {
      s.style.transform = `translate(calc(-50% + ${Math.cos(a)*44}px),calc(-50% + ${Math.sin(a)*44-20}px)) scale(0)`;
      s.style.opacity = '0';
    });
    setTimeout(() => s.remove(), 700);
  }
}

/* â”€â”€ Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function openModal(postId) {
  const { data: post } = await sb.from('posts')
    .select('*, profiles(display_name,username,avatar_url)')
    .eq('id', postId).single();
  if (!post) return;

  const { data: comments } = await sb.from('comments')
    .select('*, profiles(display_name,username,avatar_url)')
    .eq('post_id', postId)
    .order('created_at', { ascending: true });

  const voted   = state.voted.has(postId) || state.anonVoted.has(postId);
  const creator = post.profiles?.display_name || post.profiles?.username || 'â€”';
  const initials = creator[0] || 'åŒ¿';

  // [FIX] ã‚³ãƒ¡ãƒ³ãƒˆæ¬„ï¼šæœªãƒ­ã‚°ã‚¤ãƒ³ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³èª˜å°ã‚’è¡¨ç¤º
  const commentInputHtml = state.user
    ? `<div class="comment-input-wrap">
        <input type="text" class="comment-input" id="modal-comment-input"
          placeholder="${esc(t().commentPlaceholder)}"
          onkeydown="if(event.key==='Enter')submitComment('${esc(postId)}')">
        <button class="comment-send" onclick="submitComment('${esc(postId)}')">${esc(t().commentSend)}</button>
       </div>`
    : `<div class="comment-login-notice">${t().commentLoginNotice}</div>`;

  document.getElementById('modal-body').innerHTML = `
    <div class="card-badge" style="margin-bottom:16px"><div class="badge-dot ${esc(post.category)}"></div>${esc(catLabel(post.category))}</div>
    <div class="modal-title">${esc(post.title)}</div>
    <div class="modal-creator-row">
      <div class="avatar avatar-md" style="background:linear-gradient(135deg,var(--ember),var(--gold))">${esc(initials)}</div>
      <div>
        <div style="font-size:13px;color:var(--paper);letter-spacing:.05em">${esc(creator)}</div>
        <div class="modal-meta">${new Date(post.created_at).toLocaleDateString('ja-JP').replace(/\//g,'.')}${post.reason ? ` Â· ${state.lang==='ja'?'ç†ç”±ï¼š':'Reason: '}${esc(post.reason)}` : ''}</div>
      </div>
    </div>
    <div class="modal-thumb">${post.image_url ? `<img src="${esc(post.image_url)}" alt="${esc(post.title)}">` : 'æ²¡'}</div>
    <div class="modal-desc">${esc(post.full_desc)}</div>
    <div class="modal-tags">${(post.tags||[]).map(tg=>`<span class="modal-tag">#${esc(tg)}</span>`).join('')}</div>
    <div class="modal-vote-area">
      <div class="modal-vote-text">${t().modalVoteText.replace('\n','<br>')}</div>
      <button class="modal-vote-btn ${voted?'voted':''}" id="modal-vote-btn" onclick="castVote('${esc(postId)}')">
        ğŸ•¯ <span class="mvb-label">${voted ? esc(t().voted) : esc(t().revive)}</span>
        <span class="modal-vote-count"> <strong id="modal-vote-num">${post.vote_count}</strong></span>
      </button>
    </div>
    <div class="comments-section">
      <div class="comments-title">${t().commentsTitle((comments||[]).length)}</div>
      <div id="modal-comments-list">
        ${(comments||[]).map(c => {
          const cn = c.profiles?.display_name || c.profiles?.username || 'åŒ¿å';
          const ci = cn[0] || 'åŒ¿';
          return `<div class="comment-item">
            <div class="comment-head">
              <div class="avatar avatar-sm" style="background:linear-gradient(135deg,#7a9cc4,#9c7ac4)">${esc(ci)}</div>
              <div class="comment-author-name">${esc(cn)}</div>
              <div class="comment-time">${relTime(c.created_at)}</div>
            </div>
            <div class="comment-text">${esc(c.body)}</div>
          </div>`;
        }).join('')}
      </div>
      ${commentInputHtml}
    </div>`;

  document.getElementById('modal-overlay').classList.add('open');
  document.body.style.overflow = 'hidden';
}

function closeModal() {
  document.getElementById('modal-overlay').classList.remove('open');
  document.body.style.overflow = '';
}

async function submitComment(postId) {
  // [FIX] ãƒ­ã‚°ã‚¤ãƒ³ãƒã‚§ãƒƒã‚¯ã‚’å¿…ãšè¡Œã†ï¼ˆuser_id NOT NULLã®ãŸã‚ï¼‰
  if (!state.user) { showToast(t().toastLoginRequired, 'error'); return; }

  const inp  = document.getElementById('modal-comment-input');
  const body = inp?.value.trim();
  if (!body) return;

  const { error } = await sb.from('comments').insert({
    post_id: postId,
    user_id: state.user.id,
    body,
  });
  if (error) { showToast(t().toastError, 'error'); return; }

  const displayName = state.user.user_metadata.full_name || state.user.user_metadata.user_name || 'åç„¡ã—';
  const initials    = displayName[0] || 'åŒ¿';
  const list        = document.getElementById('modal-comments-list');
  const div         = document.createElement('div');
  div.className     = 'comment-item fade-up';
  div.innerHTML     = `<div class="comment-head"><div class="avatar avatar-sm" style="background:linear-gradient(135deg,var(--ember),var(--gold))">${esc(initials)}</div><div class="comment-author-name">${esc(displayName)}</div><div class="comment-time">${relTime(new Date().toISOString())}</div></div><div class="comment-text">${esc(body)}</div>`;
  list.appendChild(div);
  inp.value = '';

  const ct = document.querySelector('.comments-title');
  if (ct) ct.textContent = t().commentsTitle(list.children.length);
  showToast(t().toastCommented);
}

/* â”€â”€ Section routing â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function showSection(name) {
  state.section = name;
  ['archive','ranking','post','hof'].forEach(s => {
    const el = document.getElementById(`section-${s}`);
    if (el) el.style.display = s === name ? 'block' : 'none';
  });
  document.querySelectorAll('.nav-btn').forEach((b, i) => {
    b.classList.toggle('active', i === {archive:0,ranking:1,post:2,hof:3}[name]);
  });
  if (name === 'ranking') renderRankingPage();
  if (name === 'hof')     renderHof();
  if (name === 'post')    showPostSection();
  window.scrollTo(0, 0);
}

function showPostSection() {
  const gate     = document.getElementById('auth-gate');
  const formWrap = document.getElementById('post-form-wrap');
  if (state.user) {
    gate.style.display     = 'none';
    formWrap.style.display = 'block';
    resetForm();
  } else {
    gate.style.display     = 'block';
    formWrap.style.display = 'none';
  }
}

/* â”€â”€ Search & filter â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function initSearch() {
  const inp = document.getElementById('search-input');
  const clr = document.getElementById('search-clear');
  let timer;
  inp.addEventListener('input', () => {
    clearTimeout(timer);
    timer = setTimeout(() => {
      state.query = inp.value.trim();
      clr.classList.toggle('visible', !!state.query);
      fetchPosts();
    }, 350);
  });
  clr.addEventListener('click', () => {
    inp.value = ''; state.query = '';
    clr.classList.remove('visible');
    fetchPosts();
    inp.focus();
  });
}

function setFilter(el, cat) {
  state.filter = cat;
  document.querySelectorAll('.filter-chip').forEach(b => b.classList.remove('active'));
  el.classList.add('active');
  fetchPosts();
}

function setSort(el, sort) {
  state.sort = sort;
  document.querySelectorAll('.sort-btn').forEach(b => b.classList.remove('active'));
  el.classList.add('active');
  fetchPosts();
}

/* â”€â”€ Post form â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function resetForm() {
  state.formStep = 1; state.tags = []; state.uploadFile = null;
  state.formData = { title:'', category:'design', reason:'', shortDesc:'', description:'' };
  document.getElementById('submit-success').classList.remove('visible');
  document.getElementById('form-main').style.display = 'block';
  ['f-title','f-short-desc','f-desc'].forEach(id => { const el=document.getElementById(id); if(el) el.value=''; });
  const rs = document.getElementById('f-reason'); if(rs) rs.value='';
  const pr = document.getElementById('upload-preview'); if(pr){pr.classList.remove('visible');pr.src='';}
  const fn = document.getElementById('upload-filename'); if(fn) fn.classList.remove('visible');
  const uz = document.getElementById('upload-zone'); if(uz) uz.classList.remove('has-file');
  const sc = document.getElementById('short-counter'); if(sc) sc.textContent='0 / 140';
  const cc = document.getElementById('char-counter'); if(cc) cc.textContent='0 / 2000';
  renderTagPills();
  updateFormStep();
}

function updateFormStep() {
  document.querySelectorAll('.progress-step').forEach((el,i)=>{
    el.classList.toggle('active', i+1 === state.formStep);
    el.classList.toggle('done',   i+1 < state.formStep);
  });
  document.querySelectorAll('.form-panel').forEach((el,i) =>
    el.classList.toggle('active', i+1 === state.formStep)
  );
  if (state.formStep === 3) fillSummary();
}

function fillSummary() {
  const catMap = {design:t().catDesign,outfit:t().catOutfit,name:t().catName,lore:t().catLore,bgm:t().catBgm,other:t().catOther};
  document.getElementById('summary-title-val').textContent  = state.formData.title;
  document.getElementById('summary-cat-val').textContent    = catMap[state.formData.category] || state.formData.category;
  document.getElementById('summary-reason-val').textContent = state.formData.reason || 'â€”';
  document.getElementById('summary-short-val').textContent  = state.formData.shortDesc;
  document.getElementById('summary-desc-val').textContent   = state.formData.description.slice(0,120) + (state.formData.description.length>120?'â€¦':'');
  document.getElementById('summary-tags-val').textContent   = state.tags.length ? state.tags.map(tg=>'#'+tg).join(' ') : 'â€”';
}

function nextStep() {
  if (state.formStep === 1) {
    const title = document.getElementById('f-title').value.trim();
    if (!title) { showFieldError('f-title','f-title-err', t().titleRequired); return; }
    clearFieldError('f-title','f-title-err');
    state.formData.title    = title;
    state.formData.category = document.querySelector('.cat-radio:checked')?.value || 'design';
  }
  if (state.formStep === 2) {
    // [FIX] shortDesc ã¨ full_desc ã‚’ç‹¬ç«‹ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    const short = document.getElementById('f-short-desc').value.trim();
    if (short.length < 10) { showFieldError('f-short-desc','f-short-desc-err', t().shortDescRequired); return; }
    clearFieldError('f-short-desc','f-short-desc-err');

    const desc = document.getElementById('f-desc').value.trim();
    if (desc.length < 10) { showFieldError('f-desc','f-desc-err', t().descRequired); return; }
    clearFieldError('f-desc','f-desc-err');

    state.formData.shortDesc   = short;
    state.formData.description = desc;
    state.formData.reason      = document.getElementById('f-reason').value;
  }
  state.formStep = Math.min(state.formStep + 1, 3);
  updateFormStep();
}

function prevStep() { state.formStep = Math.max(state.formStep - 1, 1); updateFormStep(); }

function showFieldError(fid, eid, msg) {
  const f = document.getElementById(fid); const e = document.getElementById(eid);
  if (f) f.classList.add('error');
  if (e) { e.textContent = msg; e.classList.add('visible'); }
}
function clearFieldError(fid, eid) {
  const f = document.getElementById(fid); const e = document.getElementById(eid);
  if (f) f.classList.remove('error');
  if (e) e.classList.remove('visible');
}

async function submitForm() {
  if (!state.user) return;
  const btn = document.getElementById('btn-submit');
  btn.classList.add('loading');

  let imageUrl = null;

  if (state.uploadFile) {
    showToast(t().toastUploading);
    const ext  = state.uploadFile.name.split('.').pop();
    const path = `${state.user.id}/${Date.now()}.${ext}`;
    const { error: uploadErr } = await sb.storage
      .from('post-images').upload(path, state.uploadFile, { cacheControl:'3600', upsert:false });
    if (uploadErr) { showToast(t().toastError, 'error'); btn.classList.remove('loading'); return; }
    const { data: { publicUrl } } = sb.storage.from('post-images').getPublicUrl(path);
    imageUrl = publicUrl;
  }

  // [FIX] descriptionï¼ˆè¦ç´„ï¼‰ã¨ full_descï¼ˆè©³ç´°ï¼‰ã‚’æ­£ã—ãåˆ†é›¢ã—ã¦ INSERT
  const { error } = await sb.from('posts').insert({
    user_id:     state.user.id,
    title:       state.formData.title,
    category:    state.formData.category,
    reason:      state.formData.reason || null,
    description: state.formData.shortDesc,   // ä¸€è¡Œç´¹ä»‹æ–‡ â†’ description ã‚«ãƒ©ãƒ 
    full_desc:   state.formData.description, // è©³ç´°       â†’ full_desc ã‚«ãƒ©ãƒ 
    tags:        state.tags,
    image_url:   imageUrl,
  });

  btn.classList.remove('loading');
  if (error) { showToast(t().toastError, 'error'); return; }

  document.getElementById('form-main').style.display = 'none';
  document.getElementById('submit-success').classList.add('visible');
  showToast(t().toastSubmitted);
  fetchPosts();
}

/* â”€â”€ Tags â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function initTagsInput() {
  const wrap = document.getElementById('tags-wrap');
  const inp  = document.getElementById('tags-input');
  if (!wrap || !inp) return;
  wrap.addEventListener('click', () => inp.focus());
  inp.addEventListener('keydown', e => {
    if (e.key==='Enter' || e.key===' ' || e.key==='ã€€') {
      e.preventDefault();
      addTag(inp.value.replace(/\s+/g,''));
      inp.value = '';
    } else if (e.key==='Backspace' && !inp.value && state.tags.length) {
      removeTag(state.tags[state.tags.length-1]);
    }
  });
}
function addTag(val) {
  val = val.trim().replace(/^#/,'');
  if (!val || state.tags.includes(val) || state.tags.length >= 8) return;
  state.tags.push(val); renderTagPills();
}
function removeTag(val) { state.tags = state.tags.filter(tg => tg !== val); renderTagPills(); }
function renderTagPills() {
  const wrap = document.getElementById('tags-wrap');
  const inp  = document.getElementById('tags-input');
  if (!wrap) return;
  wrap.querySelectorAll('.tag-pill').forEach(p => p.remove());
  state.tags.forEach(tg => {
    const pill = document.createElement('span');
    pill.className = 'tag-pill';
    pill.innerHTML = `${esc(tg)}<button class="tag-remove" onclick="removeTag('${esc(tg)}')" type="button">Ã—</button>`;
    wrap.insertBefore(pill, inp);
  });
}

/* â”€â”€ File upload â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function initUpload() {
  const zone  = document.getElementById('upload-zone');
  const input = document.getElementById('f-image');
  const prev  = document.getElementById('upload-preview');
  const fname = document.getElementById('upload-filename');
  if (!zone) return;
  zone.addEventListener('dragover',  e => { e.preventDefault(); zone.classList.add('drag-over'); });
  zone.addEventListener('dragleave', () => zone.classList.remove('drag-over'));
  zone.addEventListener('drop', e => { e.preventDefault(); zone.classList.remove('drag-over'); handleFile(e.dataTransfer.files[0]); });
  zone.addEventListener('click', () => input.click());
  input.addEventListener('change', () => handleFile(input.files[0]));
  function handleFile(file) {
    if (!file || !file.type.startsWith('image/')) return;
    if (file.size > 10*1024*1024) { showToast(state.lang==='ja'?'ãƒ•ã‚¡ã‚¤ãƒ«ãŒå¤§ãã™ãã¾ã™ (10MBä»¥ä¸‹)':'File too large (max 10MB)','error'); return; }
    state.uploadFile = file;
    const r = new FileReader();
    r.onload = e => {
      prev.src = e.target.result; prev.classList.add('visible');
      fname.textContent = file.name; fname.classList.add('visible');
      zone.classList.add('has-file');
    };
    r.readAsDataURL(file);
  }
}

/* â”€â”€ Char counters â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function updateShortCounter() {
  const el = document.getElementById('f-short-desc');
  const ctr = document.getElementById('short-counter');
  if (!el || !ctr) return;
  const n = el.value.length;
  ctr.textContent = `${n} / 140`;
  ctr.classList.toggle('warn', n > 126);
  if (n > 140) el.value = el.value.slice(0, 140);
}
function updateFullCounter() {
  const el  = document.getElementById('f-desc');
  const ctr = document.getElementById('char-counter');
  if (!el || !ctr) return;
  const n = el.value.length;
  ctr.textContent = `${n} / 2000`;
  ctr.classList.toggle('warn', n > 1800);
  if (n > 2000) el.value = el.value.slice(0, 2000);
}
function initCharCounter() {
  // ã‚¤ãƒ™ãƒ³ãƒˆã¯HTMLã®oninputã§ç›´æ¥å‘¼ã¶ãŸã‚ã€ã“ã“ã§ã¯åˆæœŸè¡¨ç¤ºã®ã¿
  updateShortCounter(); updateFullCounter();
}

/* â”€â”€ Language â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function setLang(lang) {
  state.lang = lang;
  document.querySelectorAll('.lang-btn').forEach(b => b.classList.toggle('active', b.dataset.lang === lang));
  document.documentElement.lang = lang;
  applyLangTexts();
  renderCards();
  renderRankingSidebar();
  if (state.section === 'ranking') renderRankingPage();
  if (state.section === 'hof')     renderHof();
  document.getElementById('site-tagline').innerHTML = t().tagline.replace('\n','<br>');
  const rs = document.getElementById('f-reason');
  if (rs) {
    const v = rs.value;
    rs.innerHTML = `<option value="">${lang==='ja'?'é¸æŠã—ã¦ãã ã•ã„':'Please select'}</option>`
      + t().reasons.map(r => `<option${r===v?' selected':''}>${esc(r)}</option>`).join('');
  }
}
function applyLangTexts() {
  document.querySelectorAll('[data-t]').forEach(el => {
    const k = el.dataset.t; const v = t()[k];
    if (typeof v === 'string') el.textContent = v;
  });
  document.querySelectorAll('[data-t-placeholder]').forEach(el => {
    const k = el.dataset.tPlaceholder; const v = t()[k];
    if (typeof v === 'string') el.placeholder = v;
  });
}

/* â”€â”€ Email subscription â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function subscribeEmail() {
  const inp = document.getElementById('email-input');
  const val = inp.value.trim();
  if (!val || !val.includes('@')) {
    showToast(state.lang==='ja'?'æ­£ã—ã„ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„':'Enter a valid email','error');
    return;
  }
  inp.value = '';
  showToast(t().toastEmail);
  // TODO: Supabase ã® subscribers ãƒ†ãƒ¼ãƒ–ãƒ«ã« INSERT
}

/* â”€â”€ Realtime â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function initRealtime() {
  // [FIX] æ—¢å­˜ãƒãƒ£ãƒ³ãƒãƒ«ã‚’è§£é™¤ã—ã¦ã‹ã‚‰ã‚µãƒ–ã‚¹ã‚¯ãƒ©ã‚¤ãƒ–ï¼ˆãƒ€ãƒ–ãƒ«ç™»éŒ²é˜²æ­¢ï¼‰
  if (state.realtimeChannel) sb.removeChannel(state.realtimeChannel);

  state.realtimeChannel = sb.channel('posts-changes')
    .on('postgres_changes', { event:'INSERT', schema:'public', table:'posts' }, () => {
      if (state.section === 'archive') fetchPosts();
      renderRankingSidebar();
    })
    .on('postgres_changes', { event:'UPDATE', schema:'public', table:'posts' }, payload => {
      // [FIX] è‡ªåˆ†ã®æ“ä½œç”±æ¥ã®æ›´æ–°ã¯updateVoteDOMã§å‡¦ç†æ¸ˆã¿ã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—
      const id = payload.new.id;
      const alreadyUpdated = state.voted.has(id) || state.anonVoted.has(id);
      if (!alreadyUpdated) {
        const vn = document.getElementById(`vn-${id}`);
        if (vn) vn.textContent = payload.new.vote_count;
      }
    })
    .subscribe();
}

/* â”€â”€ Keyboard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });
document.getElementById('modal-overlay').addEventListener('click', e => {
  if (e.target === e.currentTarget) closeModal();
});

/* â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
document.addEventListener('DOMContentLoaded', async () => {
  // ã‚¢ãƒãƒ‹ãƒã‚¹æŠ•ç¥¨ã‚’LocalStorageã‹ã‚‰å¾©å…ƒ
  state.anonVoted = new Set(JSON.parse(localStorage.getItem('kuyo_anon_votes') || '[]'));

  initParticles();
  initSearch();
  initTagsInput();
  initUpload();
  initCharCounter();
  applyLangTexts();

  // [FIX] initAuthã®å®Œäº†ã‚’å¾…ã£ã¦ã‹ã‚‰fetchPostsï¼ˆloadVotedPostsã¨ã®ç«¶åˆé˜²æ­¢ï¼‰
  await initAuth();
  await fetchPosts();
  initRealtime();
  showSection('archive');
});
</script>
</body>
</html>
